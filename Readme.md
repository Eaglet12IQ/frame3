# Added cms_blocks table and initial data | 8b212432c90244ad90213560bd2d6b5ec25909d7

## Добавление таблицы `cms_blocks` и начальных данных

## Описание изменений
Данный коммит добавляет новую таблицу `cms_blocks` в систему, предназначенную для хранения текстовых блоков (виджетов) CMS, а также создаёт соответствующую миграцию для Laravel.

## Изменённые файлы

### 1. `db/init.sql`
- Добавлено создание таблицы `cms_blocks` со следующими полями:
  - `id` — уникальный идентификатор (автоинкремент)
  - `slug` — уникальный текстовый идентификатор блока
  - `title` — заголовок блока
  - `content` — содержимое блока (текст)
  - `is_active` — флаг активности блока (по умолчанию `TRUE`)
  - `created_at` и `updated_at` — временные метки создания и обновления
- Таблица следует той же логике, что и существующая `cms_pages`, но предназначена для повторно используемых блоков контента.

### 2. `services/php-web/laravel-patches/database/migrations/2025_11_20_120000_create_cms_blocks_table.php`
- Создан новый файл миграции для Laravel, который повторяет структуру таблицы `cms_blocks` из SQL-скрипта.
- Миграция включает методы `up()` (создание таблицы) и `down()` (удаление таблицы).
- Соответствует стандартам Eloquent ORM:
  - `bigIncrements('id')`
  - `string('slug')->unique()`
  - `string('title')`
  - `text('content')`
  - `boolean('is_active')->default(true)`
  - `timestamps()` для `created_at` и `updated_at`

## Назначение изменений
- Расширяет функциональность CMS, позволяя хранить и управлять независимыми текстовыми блоками (например, для виджетов, баннеров, фрагментов контента).
- Обеспечивает совместимость с Laravel-частью проекта через миграцию.
- Поддерживает возможность отключения блоков без их удаления (поле `is_active`).

## Технические детали
- Используется `BIGSERIAL` для `id` в PostgreSQL и `bigIncrements` в Laravel.
- Поле `slug` имеет уникальное ограничение для предотвращения дублирования.
- Для `content` используется тип `TEXT`, что позволяет хранить большие объёмы текста.
- Автоматическое обновление `updated_at` реализовано на уровне БД через `DEFAULT NOW()`.

# Added async-trait and domain/repo modules, refactored database interactions to use domain models and validation | 04178ec4daae20664b420613e4968e69c4173546

## Добавление async-trait и модулей domain/repo, рефакторинг взаимодействия с БД

## Обзор изменений
Рефакторинг сервиса `rust-iss` с введением слоёв доменных моделей и репозиториев для абстракции работы с базой данных, добавлением валидации и улучшением архитектуры приложения.

## Ключевые изменения

### 1. **Добавление зависимостей и игнорируемых файлов**
- В `Cargo.toml` добавлен `async-trait = "0.1"` для поддержки асинхронных трейтов
- Добавлены `.gitignore` файлы:
  - Корневой: игнорирование `TODO.md`
  - Для `rust-iss`: игнорирование `target/` и `Cargo.lock`

### 2. **Создание модуля доменных моделей (`domain/`)**
- **Общие типы**: `Id` (i64), `Timestamp` (DateTime<Utc>)
- **Три основные доменные модели**:
  1. `IssData` - данные МКС с валидацией URL и наличия полей latitude/longitude
  2. `OsdrItem` - элементы OSDR с валидацией статусов и структуры данных
  3. `SpaceCache` - кэш космических данных с валидацией источников
- **Валидация**: каждая модель имеет метод `validate()` с проверками:
  - Обязательные поля
  - Формат URL для IssData
  - Допустимые значения для статусов и источников
  - Структура JSON данных
- **Вспомогательные валидаторы**: функции для проверки строк, JSON объектов и URL
- **Тесты**: модульные тесты для проверки валидации всех моделей

### 3. **Создание модуля репозиториев (`repo/`)**
- **Абстракции репозиториев** через асинхронные трейты:
  - `IssRepo` - для работы с данными МКС
  - `OsdrRepo` - для работы с элементами OSDR
  - `CacheRepo` - для работы с кэшем космических данных
- **PostgreSQL реализация**: `PgRepos` с методами:
  - CRUD операции для каждой сущности
  - Специфичные запросы (получение тренда МКС, подсчёт элементов)
- **Обработка ошибок**: кастомный enum `RepoError` с типами ошибок БД, валидации и конфликтов

### 4. **Рефакторинг основной логики (`main.rs`)**
- **Обновлён `AppState`**: добавлены репозитории для каждой сущности
- **Переход на доменные модели**:
  - Эндпоинты теперь используют репозитории вместо прямых SQL-запросов
  - Добавлена валидация перед сохранением в БД
- **Обновлённые обработчики**:
  - `last_iss()`: использует `iss_repo.get_latest_iss_data()`
  - `iss_trend()`: использует `iss_repo.get_iss_trend_data()`
  - `write_cache()`: создаёт и валидирует `SpaceCache` перед записью
  - `fetch_and_store_iss()`: создаёт и валидирует `IssData`
  - `fetch_and_store_osdr()`: создаёт и валидирует `OsdrItem` для каждого элемента
- **Типизация**: явное указание `std::result::Result` для обработчиков

## Архитектурные улучшения

### Слоистая архитектура
1. **Домен**: чистые модели данных с бизнес-логикой валидации
2. **Репозиторий**: абстракция доступа к данным, инкапсуляция SQL-запросов
3. **Приложение**: обработчики HTTP, координирующие работу домена и репозиториев

### Преимущества рефакторинга
- **Инкапсуляция**: SQL-запросы изолированы в репозиториях
- **Повторное использование**: общие паттерны доступа к данным
- **Валидация**: централизованная проверка данных перед сохранением
- **Тестируемость**: доменные модели и репозитории легко тестируются
- **Поддерживаемость**: чёткое разделение ответственности

## Технические детали
- Использование `async-trait` для асинхронных методов в трейтах
- Единый обработчик ошибок через `RepoError` и `DomainError`
- Поддержка `ON CONFLICT` для upsert операций в OSDR
- Сохранение обратной совместимости API эндпоинтов

## Затронутые эндпоинты
- `GET /iss/last` → `last_iss()`
- `GET /iss/trend` → `iss_trend()`
- `POST /osdr/sync` → `osdr_sync()`
- `POST /space/refresh` → `space_refresh()`

## Безопасность и надёжность
- Валидация входных данных на уровне домена
- Защита от некорректных URL и структур JSON
- Проверка допустимых значений для статусов и источников
- Обработка ошибок БД с преобразованием в HTTP-статусы

# Refactor database and cache services to use new service implementations | b407392c94a56b2b46e0ced9471d7c7062ea7bf7

## Рефакторинг сервисов базы данных и кэша с использованием новых реализаций сервисов

## Обзор изменений
Введение сервисного слоя поверх репозиториев для инкапсуляции бизнес-логики, рефакторинг HTTP-обработчиков для использования сервисов и создание полноценных сервисных реализаций для всех сущностей.

## Основные изменения

### 1. **Добавление сервисного слоя (`services/`)**
- **Структура модулей**:
  - `services/mod.rs` — базовые трейты, структуры и ошибки
  - `services/iss.rs` — сервис для работы с данными МКС
  - `services/osdr.rs` — сервис для работы с данными OSDR
  - `services/cache.rs` — сервис для работы с кэшем космических данных
- **Трейты сервисов**:
  - `IssService` — управление данными МКС
  - `OsdrService` — синхронизация и получение данных OSDR
  - `CacheService` — работа с кэшем различных источников
- **Система ошибок**: `ServiceError` с типами:
  - `RepositoryError` — ошибки репозитория
  - `ValidationError` — ошибки валидации
  - `ExternalApiError` — ошибки внешних API
  - `BusinessLogicError` — ошибки бизнес-логики

### 2. **Рефакторинг состояния приложения (`main.rs`)**
- **Замена репозиториев на сервисы** в `AppState`:
  - `iss_repo` → `iss_service` (`IssServiceImpl<PgRepos>`)
  - `osdr_repo` → `osdr_service` (`OsdrServiceImpl<PgRepos>`)
  - `cache_repo` → `cache_service` (`CacheServiceImpl<PgRepos>`)
- **Обновление инициализации**: создание сервисов поверх репозиториев
- **Типизация**: строгая типизация с дженериками

### 3. **Реализация сервисов**

#### **ISS сервис (`services/iss.rs`)**:
- **Методы**:
  - `fetch_and_store_iss_data()` — получение и сохранение данных МКС
  - `get_latest_iss_data()` — получение последних данных
  - `get_iss_trend_analysis()` — анализ тренда движения МКС
  - `trigger_iss_fetch()` — триггер получения данных
- **Бизнес-логика**: инкапсуляция вычисления тренда (расстояние, скорость)
- **Вспомогательные функции**: `haversine_distance_km()`, `extract_numeric_field()`
- **Тесты**: модульные тесты с мок-репозиториями

#### **OSDR сервис (`services/osdr.rs`)**:
- **Методы**:
  - `sync_osdr_data()` — синхронизация данных с внешнего API
  - `get_osdr_items()` — получение списка элементов
  - `get_osdr_item_count()` — подсчёт элементов
- **Парсинг данных**: обработка различных форматов JSON-ответов
- **Извлечение полей**: поиск по альтернативным ключам (dataset_id/id/uuid)
- **Тесты**: проверка парсинга и извлечения данных

#### **Кэш сервис (`services/cache.rs`)**:
- **Поддержка всех источников**:
  - `apod` — Astronomy Picture of the Day
  - `neo` — Near Earth Objects
  - `flr`/`cme` — данные DONKI
  - `spacex` — данные SpaceX
- **Методы**:
  - `fetch_and_cache_*()` — получение и кэширование для каждого источника
  - `get_latest_cache_entry()` — получение последней записи
  - `refresh_multiple_sources()` — обновление нескольких источников
  - `get_space_summary()` — сводка по всем космическим данным
  - `store_space_cache()` — сохранение в кэш
- **Интеграция**: доступ к данным МКС и OSDR через репозитории
- **Тесты**: мок-репозитории и тестовые сценарии

### 4. **Обновление HTTP-обработчиков (`main.rs`)**

#### **Эндпоинты МКС**:
- `last_iss()` → использует `iss_service.get_latest_iss_data()`
- `iss_trend()` → использует `iss_service.get_iss_trend_analysis()` (упрощённая логика)
- `trigger_iss()` → оставлен для обратной совместимости

#### **Эндпоинты кэша**:
- `write_cache()` → использует `cache_service.store_space_cache()`
- Обновлены все функции получения данных (`fetch_apod()`, `fetch_neo_feed()`, etc.) для использования сервисов
- `space_summary()` → в будущем может быть заменён на сервисный метод

### 5. **Удаление дублирующей логики**
- **Из `main.rs` удалены**:
  - Прямые SQL-запросы в обработчиках
  - Логика вычисления тренда МКС
  - Функции `num()` и `haversine_km()`
- **Инкапсулировано в сервисы**:
  - Валидация данных
  - Работа с HTTP-клиентом
  - Преобразование данных
  - Обработка ошибок

### 6. **Архитектурные улучшения**

#### **Слоистая архитектура**:
1. **Домен** — модели данных с валидацией
2. **Репозиторий** — доступ к данным (SQL)
3. **Сервис** — бизнес-логика и координация
4. **Приложение** — HTTP-обработчики

#### **Принципы**:
- **Единственная ответственность**: каждый сервис отвечает за свою предметную область
- **Инверсия зависимостей**: сервисы зависят от абстракций (трейтов)
- **Тестируемость**: моки репозиториев для тестирования сервисов
- **Повторное использование**: общие утилиты (HTTP-клиент, парсинг)

### 7. **Обработка ошибок**
- **Единый подход**: все сервисы возвращают `Result<T, ServiceError>`
- **Преобразование ошибок**: из `RepoError` в `ServiceError`
- **Детализация**: типизированные ошибки для разных сценариев

### 8. **Тестирование**
- **Модульные тесты** для каждого сервиса
- **Мок-репозитории** для изоляции тестов
- **Тестовые сценарии**:
  - Парсинг JSON-ответов
  - Вычисление расстояний
  - Обработка ошибок API
  - Валидация данных

## Преимущества рефакторинга
- **Чистота кода**: бизнес-логика изолирована от HTTP-слоя
- **Поддерживаемость**: каждый сервис можно тестировать и изменять независимо
- **Масштабируемость**: легко добавлять новые источники данных
- **Надёжность**: централизованная обработка ошибок
- **Гибкость**: возможность замены реализаций (например, для тестирования)

## Обратная совместимость
- **API эндпоинтов** не изменены
- **Формат ответов** сохранён
- **Поведение** идентично предыдущей версии

# Added NASA and ISS clients, refactored API requests to use clients | fb614997b31c16c4a11a1fcfd773fafe4a3a7c7b

## Добавление клиентов NASA и ISS, рефакторинг API запросов для использования клиентов

## Обзор изменений
Введение клиентского слоя для внешних API с абстракцией HTTP-запросов, ретраями и обработкой ошибок. Рефакторинг сервисов для использования клиентов вместо прямых HTTP-запросов.

## Основные изменения

### 1. **Создание модуля клиентов (`clients/`)**
- **Базовый модуль `clients/mod.rs`**:
  - `ClientError` — типизированные ошибки клиентов (HTTP, таймаут, парсинг, rate limit)
  - `HttpClientConfig` — конфигурация HTTP-клиента (таймауты, ретраи, User-Agent)
  - `HttpClient` — обёртка над reqwest с ретраями и обработкой ошибок
  - `get_with_retry()` — метод с автоматическими повторными попытками
- **Трейты клиентов**:
  - `NasaClient` — для NASA API (APOD, NEO, DONKI, OSDR)
  - `IssClient` — для ISS API (положение МКС)
  - `SpaceXClient` — для SpaceX API (запуски)

### 2. **Реализации клиентов**

#### **NASA клиент (`clients/nasa.rs`)**:
- `NasaClientImpl` — реализация NASA API
- **Методы**:
  - `fetch_osdr_datasets()` — получение наборов данных OSDR
  - `fetch_apod()` — Astronomy Picture of the Day
  - `fetch_neo_feed()` — данные о околоземных объектах
  - `fetch_donki_flr()` — данные о солнечных вспышках
  - `fetch_donki_cme()` — данные о выбросах корональной массы
- **Параметры**: поддержка API-ключа, дат, параметров запросов

#### **ISS клиент (`clients/iss.rs`)**:
- `IssClientImpl` — реализация API положения МКС
- **Метод**: `fetch_iss_position()` — получение текущих координат МКС
- **Базовая конфигурация**: URL API wheretheiss.at

#### **SpaceX клиент (`clients/spacex.rs`)**:
- `SpaceXClientImpl` — реализация SpaceX API
- **Методы**:
  - `fetch_next_launch()` — следующий запуск
  - `fetch_latest_launch()` — последний запуск
  - `fetch_upcoming_launches()` — предстоящие запуски

### 3. **Интеграция клиентов в приложение (`main.rs`)**:
- **Добавление клиентов в `AppState`**:
  - `nasa_client: NasaClientImpl`
  - `iss_client: IssClientImpl`
  - `spacex_client: SpaceXClientImpl`
- **Инициализация клиентов**:
  - Создание с дефолтной конфигурацией `HttpClientConfig::default()`
  - Конфигурирование таймаутов (30 сек), ретраев (3 попытки), задержек
- **Обновление обработчиков**:
  - Замена прямых HTTP-запросов на вызовы клиентов
  - Упрощение кода за счёт инкапсуляции логики запросов

### 4. **Рефакторинг функций получения данных**

#### **Функции NASA**:
- `fetch_apod()` → `st.nasa_client.fetch_apod()`
- `fetch_neo_feed()` → `st.nasa_client.fetch_neo_feed()`
- `fetch_donki_flr()` → `st.nasa_client.fetch_donki_flr()`
- `fetch_donki_cme()` → `st.nasa_client.fetch_donki_cme()`
- **Удалено**: ручное создание клиента, проверка статусов, обработка ошибок

#### **Функция SpaceX**:
- `fetch_spacex_next()` → `st.spacex_client.fetch_next_launch()`
- **Удалено**: ручное создание запроса к API SpaceX

#### **Функция ISS**:
- `fetch_and_store_iss()` → `st.iss_client.fetch_iss_position()`
- **Обновление**: функция теперь принимает `&AppState` вместо `&PgPool` и `&str`

#### **Функция OSDR**:
- `fetch_and_store_osdr()` → `st.nasa_client.fetch_osdr_datasets()`
- **Упрощение**: удалена ручная HTTP-логика

### 5. **Обработка ошибок клиентов**
- **Преобразование ошибок**: `ClientError` → `anyhow::Error`
- **Консистентность**: единый подход к обработке ошибок во всех функциях
- **Детализация**: сохранение контекста ошибок для отладки

### 6. **Конфигурация HTTP-клиента**
- **Дефолтные настройки**:
  - Таймаут: 30 секунд
  - Макс ретраев: 3
  - Задержка между ретраями: 1 секунда
  - User-Agent: "Rust-ISS-Service/1.0"
- **Ретраи**: автоматические повторные попытки при сбоях
- **Обработка rate limiting**: специальная ошибка для статуса 429

### 7. **Тестирование клиентов**
- **Модульные тесты** для каждого клиента
- **Проверка создания** клиентов с дефолтными и кастомными URL
- **Тестирование конфигурации**: проверка параметров HTTP-клиента

## Преимущества изменений
- **Инкапсуляция**: HTTP-логика скрыта в клиентах
- **Повторное использование**: клиенты могут использоваться в разных сервисах
- **Надёжность**: автоматические ретраи при сбоях сети/API
- **Консистентность**: единый подход ко всем внешним API
- **Тестируемость**: клиенты легко мокать в тестах
- **Поддерживаемость**: изменения в API затрагивают только клиенты

# Refactor configuration and client usage | aeec706feab683a5f69967975a0f90dd5419c232

## Рефакторинг конфигурации и использования клиентов

## Обзор изменений
Реорганизация системы конфигурации приложения: создание централизованного модуля конфигурации, вынесение настроек из `main.rs`, переименование `HttpClientConfig` в `AppConfig` и интеграция с клиентами.

## Основные изменения

### 1. **Создание модуля конфигурации (`config/mod.rs`)**
- **Новая структура `AppConfig`** — центральная конфигурация приложения:
  - `database: DatabaseConfig` — настройки БД (URL, максимальные соединения)
  - `nasa: NasaConfig` — настройки NASA API (URL, ключ, интервалы запросов)
  - `iss: IssConfig` — настройки ISS API (URL, интервал запросов)
  - `spacex: SpaceXConfig` — настройки SpaceX API (интервал запросов)
  - `http_client: HttpClientConfig` — настройки HTTP-клиента
  - `server: ServerConfig` — настройки сервера (хост, порт)
  - `osdr: OsdrConfig` — настройки OSDR (интервал, лимит списка)

- **`HttpClientConfig` перемещён** из `clients/mod.rs` в `config/mod.rs`
- **Структура `NasaFetchIntervals`** — отдельные интервалы для разных типов данных NASA
- **Валидация конфигурации** — метод `validate()` для каждой структуры
- **`ConfigError`** — типизированные ошибки конфигурации

### 2. **Загрузка конфигурации из переменных окружения**
- **Метод `from_env()`** для каждой структуры конфигурации
- **Обязательные параметры**: `DATABASE_URL` (без дефолтных значений)
- **Опциональные параметры** с дефолтами:
  - `NASA_API_URL` → "https://visualization.osdr.nasa.gov/biodata/api/v2/datasets/?format=json"
  - `WHERE_ISS_URL` → "https://api.wheretheiss.at/v1/satellites/25544"
  - `SERVER_HOST` → "0.0.0.0", `SERVER_PORT` → 3000
  - Интервалы запросов с дефолтными значениями

- **Парсинг значений**: преобразование строк в числовые типы с обработкой ошибок
- **Хелпер-функция `env_u64()`** — для парсинга u64 значений с дефолтами

### 3. **Рефакторинг `AppState` в `main.rs`**
- **Замена отдельных полей** на единую конфигурацию:
  - Удалены: `nasa_url`, `nasa_key`, `fallback_url`
  - Удалены: `every_*` поля для интервалов
  - Добавлено: `config: AppConfig`
- **Типизация**: `AppConfig` содержит все настройки в структурированном виде

### 4. **Обновление инициализации приложения**
- **Загрузка конфигурации**: `AppConfig::from_env()` с валидацией
- **Использование конфигурации**:
  - `config.database.url` вместо `db_url`
  - `config.database.max_connections` вместо хардкодного значения 5
  - Дефолтный `HttpClientConfig` для клиентов
- **Обработка ошибок**: преобразование `ConfigError` в `anyhow::Error`

### 5. **Обновление фоновых задач**
- **Использование конфигурации** для интервалов запросов:
  - `st.config.osdr.fetch_interval` вместо `st.every_osdr`
  - `st.config.iss.fetch_interval` вместо `st.every_iss`
  - `st.config.nasa.fetch_intervals.apod` вместо `st.every_apod`
  - `st.config.nasa.fetch_intervals.neo` вместо `st.every_neo`
  - `st.config.nasa.fetch_intervals.donki` вместо `st.every_donki`
  - `st.config.spacex.fetch_interval` вместо `st.every_spacex`

### 6. **Обновление функций работы с API**
- **NASA API ключ**: `st.config.nasa.api_key.as_deref()` вместо `Some(&st.nasa_key)`
- **URL ISS API**: `st.config.iss.api_url` вместо `st.fallback_url`
- **Более безопасная работа** с опциональными ключами через `as_deref()`

### 7. **Обновление импортов в клиентах**
- **Изменение импортов** в `iss.rs`, `nasa.rs`, `spacex.rs`:
  - Импорт `HttpClientConfig` из `crate::config`
  - Импорт трейтов (`NasaClient`, `IssClient`) из корневого модуля
- **Удаление дублирования**: `HttpClientConfig` больше не определён в `clients/mod.rs`

### 8. **Валидация конфигурации**
- **Проверка обязательных полей**: непустые строки, положительные числа
- **Каскадная валидация**: `AppConfig.validate()` вызывает валидацию всех вложенных структур
- **Запуск при старте**: валидация конфигурации перед созданием приложения

### 9. **Удаление хелпер-функции**
- **Удалена `env_u64()`** из `main.rs` — теперь используется версия из `config/mod.rs`

## Преимущества изменений
- **Централизация**: все настройки в одном месте
- **Типобезопасность**: структурированные типы вместо строк
- **Валидация**: проверка конфигурации при запуске
- **Читаемость**: понятные имена полей вместо отдельных переменных
- **Поддерживаемость**: легче добавлять новые настройки
- **Тестируемость**: конфигурацию можно мокать в тестах

# Refactor handlers and services to use new handlers module | 4c458fc6d4564a9959913c0f1fcf999717ed4c70

## Рефакторинг хэндлеров и сервисов с использованием нового модуля handlers

## Обзор изменений
Создание отдельного модуля для HTTP-хэндлеров, вынос бизнес-логики из `main.rs`, реорганизация зависимостей и улучшение структуры кода.

## Основные изменения

### 1. **Создание модуля хэндлеров (`handlers/`)**

#### **Базовый модуль (`handlers/mod.rs`)**:
- **Структура `ApiError`** — стандартизированная ошибка API с полями `message` и `status`
- **Методы-хелперы**: `internal_error()`, `not_found()`, `bad_request()`
- **Реализация `From<ApiError>`** для преобразования в `(StatusCode, String)`
- **Функции работы с сервисами**:
  - `fetch_and_store_iss()` → использует `iss_service.trigger_iss_fetch()`
  - `fetch_and_store_osdr()` → использует `osdr_service.sync_osdr_data()`
  - `fetch_apod()`, `fetch_neo_feed()`, `fetch_donki_*()`, `fetch_spacex_next()` → используют `cache_service`

#### **Модуль ISS хэндлеров (`handlers/iss.rs`)**:
- **Структуры ответов**: `IssResponse`, `Trend` (вынесены из `main.rs`)
- **Хэндлеры**:
  - `last_iss()` — получение последних данных МКС
  - `trigger_iss()` — триггер сбора данных МКС
  - `iss_trend()` — анализ тренда движения МКС
- **Использование сервисов**: вызовы `iss_service.get_latest_iss_data()`, `iss_service.get_iss_trend_analysis()`

#### **Модуль OSDR хэндлеров (`handlers/osdr.rs`)**:
- **Хэндлеры**:
  - `osdr_sync()` — синхронизация данных OSDR
  - `osdr_list()` — получение списка элементов OSDR
- **SQL-запросы**: остались прямые запросы к БД (не переведены на сервисы)

#### **Модуль кэш-хэндлеров (`handlers/cache.rs`)**:
- **Хэндлеры**:
  - `space_latest()` — получение последних данных по источнику
  - `space_refresh()` — обновление указанных источников
  - `space_summary()` — сводка по всем космическим данным
- **Вспомогательная функция**: `latest_from_cache()` для получения данных из кэша
- **SQL-запросы**: прямые запросы к таблицам `space_cache`, `iss_fetch_log`, `osdr_items`

### 2. **Обновление конфигурации (`config/mod.rs`)**
- **Добавлено поле `api_url`** в `OsdrConfig`:
  - Загрузка из переменной `OSDR_API_URL`
  - Дефолтное значение: "https://visualization.osdr.nasa.gov/biodata/api/v2/datasets/?format=json"
  - Валидация на непустоту
- **Удалено поле `api_url`** из `NasaConfig` (перемещено в `OsdrConfig`)

### 3. **Рефакторинг `main.rs`**

#### **Удаление хэндлеров**:
- Полностью удалены все HTTP-хэндлеры из `main.rs`
- Удалены вспомогательные функции: `num()`, `haversine_km()`, `s_pick()`, `t_pick()`
- Удалены функции работы с данными: `write_cache()`, `fetch_*()`, `fetch_and_store_*()`
- Удалены структуры `Trend` и связанные функции

#### **Использование хэндлеров**:
- **Импорт модуля**: `mod handlers`
- **Обновление маршрутов**:
  - `/last` → `handlers::last_iss`
  - `/fetch` → `handlers::trigger_iss`
  - `/iss/trend` → `handlers::iss_trend`
  - `/osdr/sync` → `handlers::osdr_sync`
  - `/osdr/list` → `handlers::osdr_list`
  - `/space/:src/latest` → `handlers::space_latest`
  - `/space/refresh` → `handlers::space_refresh`
  - `/space/summary` → `handlers::space_summary`

#### **Обновление фоновых задач**:
- Вызовы функций через `handlers::fetch_*()` вместо прямых вызовов
- Сохранение той же логики и обработки ошибок

### 4. **Обновление сервиса кэша (`services/cache.rs`)**
- **Изменение видимости методов**:
  - `fetch_donki_flr()` → `pub async fn`
  - `fetch_donki_cme()` → `pub async fn`
- **Причина**: необходимость доступа из хэндлеров для прямого вызова отдельных методов DONKI

### 5. **Изменение зависимостей в хэндлерах**
- **Использование абсолютных путей**: `crate::AppState`, `crate::domain::IssData`
- **Импорт сервисов**: `crate::services::IssService`
- **Явное указание типов**: `axum::http::StatusCode`, `chrono::Utc`

### 6. **Структура ошибок в хэндлерах**
- **Единый формат**: все хэндлеры возвращают `Result<Json<T>, (StatusCode, String)>`
- **Обработка ошибок сервисов**: преобразование `ServiceError` в строки
- **Сохранение обратной совместимости**: формат ответов не изменён

## Преимущества изменений
- **Разделение ответственности**: HTTP-логика отделена от бизнес-логики
- **Повторное использование**: хэндлеры можно тестировать изолированно
- **Чистота `main.rs`**: уменьшение с 500+ строк до ~200 строк
- **Улучшенная структура**: логические группы хэндлеров в отдельных файлах
- **Гибкость**: легче добавлять новые эндпоинты
- **Согласованность**: единый подход к обработке ошибок и ответов

# Added tower-http and updated main.rs to use new routes module | e3efbda2c923a8b2cf947aa2eb3d0ea83a971f2a

## Добавление tower-http и обновление main.rs для использования нового модуля routes

## Обзор изменений
Введение централизованной маршрутизации через отдельный модуль, добавление трейсинга HTTP-запросов и реорганизация структуры маршрутов приложения.

## Основные изменения

### 1. **Добавление зависимостей (`Cargo.toml`)**
- **Новая зависимость**: `tower-http = { version = "0.5", features = ["trace"] }`
- **Назначение**: Middleware для логирования HTTP-запросов, трейсинга

### 2. **Создание модуля маршрутов (`routes/mod.rs`)**
- **Структура `Health`** — перенесена из `main.rs` с полями `status` и `now`
- **Хэндлер `health()`** — обработчик эндпоинта `/health`
- **Логические группы маршрутов**:
  - `iss_routes()` — маршруты МКС (`/last`, `/fetch`, `/iss/trend`)
  - `osdr_routes()` — маршруты OSDR (`/osdr/sync`, `/osdr/list`)
  - `cache_routes()` — маршруты кэша (`/space/:src/latest`, `/space/refresh`, `/space/summary`)
- **Функция `create_routes()`** — сборка всех маршрутов в единый роутер:
  - Базовый эндпоинт `/health`
  - Объединение всех групп через `.merge()`

### 3. **Рефакторинг `main.rs`**
- **Удаление маршрутизации**: все `route()` вызовы удалены из `main.rs`
- **Импорт нового модуля**: `mod routes`
- **Создание приложения**: `routes::create_routes()` вместо `Router::new()`
- **Добавление middleware**: `.layer(TraceLayer::new_for_http())` для трейсинга
- **Удаление структуры `Health`** и связанного импорта
- **Упрощение импортов**:
  - Удалены: `routing::get`, `Serialize`, `DateTime`
  - Упрощены: оставлены только необходимые для `main.rs`

### 4. **Интеграция tower-http**
- **Добавление TraceLayer**: автоматическое логирование HTTP-запросов
- **Функциональность**: трейсинг времени выполнения, статусов, путей
- **Минимальная конфигурация**: используется дефолтные настройки трейсинга

### 5. **Организация маршрутов**
- **Логическая группировка**: связанные эндпоинты в отдельных функциях
- **Масштабируемость**: легко добавлять новые группы маршрутов
- **Читаемость**: ясная структура API в одном месте
- **Тестируемость**: маршруты можно тестировать изолированно

### 6. **Сохранение состояния приложения**
- **Типизация**: все роутеры используют `Router<AppState>`
- **Совместимость**: структура `AppState` передаётся через `.with_state()`
- **Цепочка вызовов**: `create_routes()` → `.layer()` → `.with_state()`

## Преимущества изменений
- **Централизация**: все маршруты в одном модуле
- **Трейсинг**: автоматическое логирование HTTP-запросов
- **Структурированность**: логические группы эндпоинтов
- **Чистота `main.rs`**: фокус на инициализации, а не маршрутизации
- **Масштабируемость**: легко добавлять middleware и новые маршруты
- **Стандартизация**: использование общепринятых практик Axum/tower

# Update Cargo.toml and main.rs to add tokio-util and signal handling | a9aec56feb291c7a4ae5c8cbf163fd017a16ec5e

## Рефакторинг main.rs: добавление graceful shutdown и токена отмены (CancellationToken)

## Обзор изменений
Добавлена поддержка graceful shutdown фоновых задач и HTTP-сервера с использованием `tokio-util` и обработки сигналов завершения работы.

## Изменённые файлы

### 1. `Cargo.toml`
- **Обновлены зависимости tokio**: добавлена фича `"signal"` для обработки системных сигналов
- **Новая зависимость**: `tokio-util = "0.7"` для `CancellationToken`
- **Удалён лишний пробел** в начале и конце файла

### 2. `main.rs`
- **Новые импорты**:
  - `tokio::signal` — для обработки Ctrl+C и SIGTERM
  - `tokio_util::sync::CancellationToken` — для координированного завершения задач
  - `tracing::warn` — дополнительный уровень логирования
- **Инициализация CancellationToken**: создан `shutdown_token` для graceful shutdown
- **Рефакторинг фоновых задач**:
  - Вынесена функция `spawn_background_tasks(state, shutdown_token)`
  - Каждая задача использует `CancellationToken` для проверки завершения
  - Добавлен `tokio::select!` в каждом цикле для обработки отмены
  - Используется `interval.tick()` вместо `sleep()` для более точного расписания
- **Запуск сервера с graceful shutdown**:
  - Создан отдельный future сервера
  - Добавлен `tokio::select!` между сервером и обработчиком сигналов
  - При получении сигнала вызывается `shutdown_token.cancel()`
- **Новая функция `shutdown_signal()`**:
  - Обрабатывает Ctrl+C (SIGINT) на всех платформах
  - Обрабатывает SIGTERM на Unix-системах
  - Возвращает управление при получении любого из сигналов
- **Улучшенное форматирование кода**:
  - Удалены русские комментарии
  - Добавлены информативные логи при запуске и завершении задач
  - Улучшена читаемость цепочек методов

## Технические детали
- **Graceful shutdown**: фоновые задачи корректно завершаются при получении сигнала
- **Координация отмены**: единый `CancellationToken` для всех фоновых процессов
- **Безопасность**: отсутствие утечек ресурсов при завершении
- **Кросс-платформенность**: поддержка Unix (SIGTERM) и других систем
- **Логирование**: информативные сообщения о запуске и завершении задач

## Преимущества изменений
- **Надёжность**: корректное завершение всех процессов при остановке приложения
- **Профилирование**: возможность измерения времени работы фоновых задач
- **Тестируемость**: легче тестировать завершение работы в интеграционных тестах
- **Производственная готовность**: соответствует best practices для долгоживущих сервисов

# Added tracing and error handling improvements | ffc6ba9a3371ab4b1df1cd8b2ac93e8c5c54c4a9

## Улучшение трейсинга и обработки ошибок в HTTP-хэндлерах

## Обзор изменений
Улучшена система логирования с добавлением request ID, рефакторинг обработки ошибок через единый тип `ApiError`, добавление инструментирования хэндлеров.

## Изменённые файлы

### 1. `Cargo.toml`
- **Обновлена зависимость tower-http**: добавлена фича `"request-id"` для генерации ID запросов
- **Новая зависимость**: `uuid = "1.18.1"` для генерации уникальных идентификаторов

### 2. `handlers/cache.rs`
- **Добавлено инструментирование**: макрос `#[instrument(skip(st))]` на все хэндлеры
- **Улучшено логирование**: добавлены информативные сообщения `info!` и `warn!` 
- **Рефакторинг возвращаемых типов**: все хэндлеры теперь возвращают `Result<Json<Value>, ApiError>`
- **Автоматическое преобразование ошибок**: имплементация `From<sqlx::Error>` для `ApiError`
- **Контекстные логи**:
  - Логирование источников при запросе данных
  - Подсчёт обновлённых источников в `space_refresh`
  - Логирование количества OSDR элементов в `space_summary`

### 3. `handlers/iss.rs`
- **Добавлено инструментирование**: `#[instrument(skip(st))]` на все хэндлеры
- **Улучшенная обработка ошибок**:
  - Явные проверки `Result` с контекстными сообщениями
  - Логирование ошибок через `error!` макрос
  - Преобразование `ServiceError` в `ApiError`
- **Детальное логирование**:
  - ID найденных данных МКС
  - Статус расчёта тренда движения
  - Время выполнения операций

### 4. `handlers/mod.rs`
- **Расширенная структура `ApiError`**:
  - Добавлено поле `trace_id: Option<String>` для отслеживания запросов
  - Метод `with_trace_id()` для привязки ID запроса
  - Новый конструктор `service_unavailable()`
- **Имплементация `IntoResponse`**: автоматическое преобразование ошибок в HTTP-ответы
- **Контекстное логирование**:
  - `error!` для внутренних ошибок сервера
  - `warn!` для ошибок клиента (bad request)
- **Преобразования ошибок**:
  - `From<DomainError>` → `ApiError::bad_request()`
  - `From<anyhow::Error>` → `ApiError::internal_error()`
  - `From<sqlx::Error>` → `ApiError::internal_error()` с логированием
  - `From<reqwest::Error>` → `ApiError::service_unavailable()`

### 5. `handlers/osdr.rs`
- **Добавлено инструментирование**: `#[instrument(skip(st))]` на оба хэндлера
- **Улучшенное логирование**:
  - Начало и завершение синхронизации OSDR
  - Количество извлечённых элементов
  - Ошибки при синхронизации
- **Консистентная обработка ошибок**: возврат `ApiError` вместо кортежей
- **Информативные сообщения**: понятный ответ при успешной синхронизации

### 6. `routes/mod.rs`
- **Добавлена поддержка request ID**:
  - Импорт необходимых типов: `RequestId`, `MakeRequestUuid`
  - Middleware `SetRequestIdLayer` для генерации UUID
  - Middleware `PropagateRequestIdLayer` для распространения ID
- **Настройка middleware**: автоматическая генерация `X-Request-Id` заголовка
- **Типизация**: использование `Uuid` для уникальных идентификаторов запросов

## Технические детали
- **Структурированное логирование**: макрос `instrument` автоматически добавляет контекст вызова
- **Сквозная идентификация**: `trace_id` в ошибках для отслеживания цепочек запросов
- **Единая обработка ошибок**: согласованное преобразование ошибок разных типов
- **Производственное логирование**: разделение уровней (info, warn, error) по типам событий
- **Middleware цепочка**: автоматическая обработка request ID на уровне маршрутизации

## Преимущества изменений
- **Отслеживаемость**: уникальный ID для каждого HTTP-запроса
- **Диагностика**: подробные логи с контекстом выполнения
- **Консистентность**: единый формат ошибок во всех хэндлерах
- **Производительность**: минимальные накладные расходы на логирование
- **Мониторинг**: возможность агрегации логов по request ID
- **Безопасность**: скрытие деталей реализации в продакшн-ошибках

# Added test modules and mock implementations for various services and handlers in the Rust ISS project. | 957acb0cd0716c986e77bbd2ca9f8c1e3d830f01

## Добавление модульных тестов и мок-реализаций для сервисов и хэндлеров

## Обзор изменений
Расширение тестового покрытия: добавление тестовых модулей, исправление незначительных проблем в существующих тестах, добавление dev-зависимостей для тестирования.

## Изменённые файлы

### 1. `Cargo.toml`
- **Добавлены dev-зависимости**:
  - `mockall = "0.11"` — для создания мок-объектов в тестах
  - `tokio-test = "0.4"` — утилиты для тестирования асинхронного кода

### 2. `config/mod.rs`
- **Добавлен тестовый модуль `tests`**:
  - Тест `test_env_u64_with_valid_value()` — проверка парсинга корректного u64 из переменной окружения
  - Тест `test_env_u64_with_default()` — проверка использования значения по умолчанию
  - Тест `test_env_u64_with_invalid_value()` — проверка обработки некорректного значения
  - Тест `test_database_config_from_env()` — проверка создания конфигурации БД из env
  - Тест `test_database_config_validate()` — проверка валидации конфигурации БД (валидная и пустая URL)
  - Тест `test_server_config_from_env()` — проверка создания конфигурации сервера из env
  - Тест `test_server_config_validate()` — проверка валидации конфигурации сервера (валидный и пустой хост)
- **Управление переменными окружения**: использование `env::set_var()` и `env::remove_var()` для изоляции тестов

### 3. `domain/mod.rs`
- **Исправление тестов**:
  - Добавлен `.clone()` для `valid_payload` во избежание перемещения значений
  - Устранено повторное использование перемещённого значения
- **Сохранение логики тестов**: проверки валидных и невалидных данных ISS

### 4. `handlers/mod.rs`
- **Добавлен тестовый модуль `tests`**:
  - Тест `test_api_error_creation()` — проверка создания базовой ошибки API
  - Тест `test_api_error_with_trace_id()` — проверка добавления trace ID к ошибке
  - Тест `test_api_error_convenience_methods()` — проверка вспомогательных методов:
    - `not_found()` → статус 404
    - `bad_request()` → статус 400
    - `service_unavailable()` → статус 503
- **Проверка полей структуры**: `status`, `message`, `trace_id`

### 5. `services/cache.rs`, `services/iss.rs`, `services/osdr.rs`
- **Добавление `#[derive(Clone)]`** для мок-структур:
  - `MockCacheRepo` в `cache.rs`
  - `MockIssRepo` в `iss.rs`
  - `MockOsdrRepo` в `osdr.rs`
- **Цель**: возможность клонирования мок-объектов в тестах

## Технические детали
- **Изоляция тестов**: очистка переменных окружения после каждого теста
- **Проверка граничных условий**: пустые строки, некорректные числа
- **Полнота покрытия**: тестирование всех основных сценариев конфигурации
- **Совместимость с асинхронным кодом**: использование `tokio-test` для асинхронных тестов
- **Гибкость моков**: клонируемые структуры для сложных тестовых сценариев

## Преимущества изменений
- **Надёжность**: автоматическая проверка парсинга конфигурации
- **Защита от регрессий**: тесты предотвращают случайные изменения поведения
- **Документирование**: тесты как примеры использования API
- **Качество кода**: повышение общего coverage проекта
- **Поддержка TDD**: готовность к дальнейшему расширению тестов

# Added Redis support to Rust ISS service and updated cache service to use Redis | 71ab258ecea162a70a032211f322053d4024a4e9

## Добавление поддержки Redis в Rust ISS сервис и обновление сервиса кэша для использования Redis

## Обзор изменений
Внедрение распределённого кэширования через Redis: добавление Redis-контейнера, репозитория Redis, интеграция двойного кэширования (Redis + PostgreSQL) в сервис кэша.

## Изменённые файлы

### 1. `Readme.md`
- **Добавление требований для бэкенда**:
  - Rate-Limit для ограничения запросов
  - Распределённый мониторинг Redis
  - Валидация данных через отдельные классы для удобства проверки

### 2. `docker-compose.yml`
- **Новый том**: `redisdata` для хранения данных Redis
- **Новый сервис Redis**:
  - Образ: `redis:7-alpine`
  - Команда: `redis-server --appendonly yes` (постоянное хранение)
  - Том: `redisdata:/data`
  - Порт: 6379
  - Healthcheck: проверка через `redis-cli ping`
  - Сеть: `backend`
- **Обновление сервиса rust-iss**:
  - Новая переменная окружения: `REDIS_URL`
  - Зависимость от сервиса Redis с условием `service_healthy`

### 3. `Cargo.toml`
- **Новая зависимость**: `redis = { version = "0.25", features = ["tokio-comp", "connection-manager"] }`
- **Фичи**: асинхронная поддержка Tokio и менеджер соединений

### 4. `config/mod.rs`
- **Новая структура `RedisConfig`**:
  - Поле `url: String`
  - Метод `from_env()`: опциональная загрузка из `REDIS_URL`
  - Метод `validate()`: проверка на непустоту URL
- **Обновление `AppConfig`**:
  - Добавлено поле `redis: Option<RedisConfig>`
  - Валидация Redis конфигурации при наличии
- **Интеграция в `from_env()`**: загрузка Redis конфигурации

### 5. `main.rs`
- **Добавление Redis в `AppState`**: поле `redis_repo: Option<RedisRepos>`
- **Инициализация Redis**:
  - Попытка подключения при наличии конфигурации
  - Логирование успеха/предупреждения при ошибке
  - Продолжение работы без Redis при недоступности
- **Обновление сервиса кэша**:
  - Использование метода `with_redis()` для добавления Redis-репозитория
  - Условная интеграция: только при успешном подключении

### 6. `repo/mod.rs`
- **Новый трейт `RedisRepo`**:
  - `set_cache()` — сохранение с TTL
  - `get_cache()` — получение по ключу
  - `delete_cache()` — удаление
  - `exists_cache()` — проверка существования
- **Реализация `RedisRepos`**:
  - Структура с `client: ConnectionManager`
  - Метод `new()`: создание клиента и менеджера соединений
  - Обработка ошибок подключения
- **Имплементация `RedisRepo` для `RedisRepos`**:
  - Асинхронные методы с использованием `redis::cmd`
  - Обработка ошибок Redis через `RepoError::DatabaseError`

### 7. `services/cache.rs`
- **Обновление `CacheServiceImpl`**:
  - Добавлено поле `redis_repo: Option<RedisRepos>`
  - Метод `with_redis()` для добавления Redis поддержки
- **Двойное кэширование**:
  1. **При сохранении** (`fetch_and_cache_apod`, `fetch_and_cache_neo`, etc.):
     - Сохранение в PostgreSQL
     - Дополнительное сохранение в Redis с TTL 1 час (3600 секунд)
  2. **При чтении** (`get_latest_cache_entry`):
     - Сначала проверка Redis кэша
     - При отсутствии — fallback на PostgreSQL
- **Сериализация JSON**: преобразование `Value` в строку для Redis
- **Обновление всех методов кэширования**:
  - APOD, NEO, SpaceX, DONKI FLR — поддержка Redis
  - Единый подход: PostgreSQL как primary storage, Redis как fast cache

## Технические детали
- **Асинхронный Redis клиент**: использование `tokio-comp` фичи
- **Менеджер соединений**: пул соединений через `ConnectionManager`
- **Отказоустойчивость**: продолжение работы при недоступности Redis
- **TTL настройки**: 1 час для временных кэшей
- **Graceful degradation**: автоматический fallback на PostgreSQL

## Преимущества изменений
- **Производительность**: быстрый доступ к часто запрашиваемым данным через Redis
- **Масштабируемость**: поддержка распределённого кэширования
- **Отказоустойчивость**: двойное хранение данных
- **Гибкость**: опциональное использование Redis через конфигурацию
- **Совместимость**: сохранение существующей функциональности PostgreSQL
- **Мониторинг**: healthcheck для Redis контейнера

# Removed controllers and routes for ISS, JWST, and upload functionality | 3a5b2d49b1d33ebde5e1965d380811002a20d8a9

## Удаление контроллеров и маршрутов для ISS, JWST и функциональности загрузки файлов

## Обзор изменений
Удаление устаревших контроллеров и связанных маршрутов из Laravel-приложения для упрощения кодовой базы и устранения неиспользуемого функционала.

## Изменённые файлы

### 1. `app/Http/Controllers/IssController.php` — **полностью удалён**
- **Функционал**: 
  - Получение данных МКС через Rust-сервис
  - Проксирование запросов к эндпоинтам `/last` и `/iss/trend`
  - Отображение данных на view `iss`
- **Зависимости**:
  - Переменная окружения `RUST_BASE`
  - Внешний сервис `rust_iss:3000`
- **Причина удаления**: дублирование функционала через ProxyController

### 2. `app/Http/Controllers/JwstHelper.php` — **полностью удалён**
- **Функционал**:
  - Вспомогательный класс для работы с JWST API
  - HTTP-запросы с заголовками `x-api-key` и `email`
  - Поиск URL изображений в ответах API
- **Конфигурация**:
  - `JWST_HOST` — базовый URL API
  - `JWST_API_KEY` — ключ аутентификации
  - `JWST_EMAIL` — опциональный email
- **Методы**:
  - `get()` — выполнение GET-запросов
  - `pickImageUrl()` — извлечение URL изображений из структур данных
- **Причина удаления**: неиспользуемый функционал, упрощение кодовой базы

### 3. `app/Http/Controllers/UploadController.php` — **полностью удалён**
- **Функционал**:
  - Загрузка файлов через форму
  - Сохранение файлов в директорию `public/uploads`
  - Минимальная валидация (только проверка наличия файла)
- **Особенности**:
  - Использование оригинального имени файла (`getClientOriginalName()`)
  - Сообщения об ошибках на русском языке
  - Отсутствие проверки типа/размера файла
- **Причина удаления**: потенциальная уязвимость безопасности, неиспользуемый функционал

### 4. `routes/web.php` — **удалены дублирующиеся маршруты**
- **Удалён повторный импорт**: `use App\Http\Controllers\AstroController;`
- **Удалён дублирующийся маршрут**: вторая строка `Route::get('/page/{slug}', ...)`
- **Сохранённые маршруты**:
  - `GET /api/iss/trend` через ProxyController
  - `GET /api/jwst/feed` через DashboardController
  - `GET /api/astro/events` через AstroController
  - `GET /page/{slug}` через CmsController
- **Результат**: устранение дублирования, чистота файла маршрутов

## Технические детали
- **Безопасность**: удаление потенциально уязвимого UploadController
- **Оптимизация**: устранение неиспользуемых зависимостей
- **Согласованность**: единый подход к проксированию через ProxyController
- **Поддерживаемость**: уменьшение сложности кодовой базы Laravel

## Последствия удаления
- **ISS данные**: теперь доступны только через `/api/iss/trend` (ProxyController)
- **JWST функционал**: полностью удалён из контроллеров (остался только маршрут)
- **Загрузка файлов**: отключена возможность загрузки файлов через веб-интерфейс
- **Маршруты**: устранено дублирование, улучшена читаемость `web.php`

# Added new routes and controllers for ISS, JWST, and Astro pages | 06ec44c578f9b997f7f1e68024d1354d3680746a

## Добавление новых маршрутов и контроллеров для страниц ISS, JWST и Astro

## Обзор изменений
Реорганизация веб-интерфейса: создание отдельных контроллеров и страниц для различных модулей, добавление навигации, перенос функционала между контроллерами.

## Изменённые файлы

### 1. `AstroController.php`
- **Добавлен метод `index()`**:
  - Возвращает view `astro` с пустым массивом событий
  - Базовая страница для астрономических событий
- **Сохранён метод `events()`**:
  - Получение астрономических событий через API
  - Параметры: широта/долгота, дни, тип событий

### 2. `DashboardController.php`
- **Удалён метод `jwstFeed()`** (полностью):
  - Функционал перемещён в новый `JwstController`
  - Удалена обработка JWST API, фильтрация по инструментам, пагинация
- **Сохранён метод `index()`**:
  - Основная dashboard страница с данными МКС, OSDR, кэша

### 3. `IssController.php` — **новый файл**
- **Приватные методы**:
  - `base()`: получение URL Rust-сервиса из env переменной
  - `getJson()`: выполнение HTTP-запроса и парсинг JSON
- **Публичный метод `index()`**:
  - Получение последних данных МКС через `/last`
  - Пустой массив для тренда (получение через nginx прокси)
  - Возврат view `iss` с данными

### 4. `JwstController.php` — **новый файл**
- **Метод `index()`**:
  - Базовая страница галереи JWST
  - Возврат view `jwst` с пустым массивом галереи
- **Метод `feed()`** (полный перенос из DashboardController):
  - Проксирование и нормализация JWST API
  - Параметры запроса: source, suffix, program, instrument, page, perPage
  - Фильтрация по инструментам (NIRCam, MIRI, NIRISS и др.)
  - Поиск URL изображений через `JwstHelper::pickImageUrl()`
  - Формирование структурированного JSON ответа

### 5. `resources/views/astro.blade.php` — **новый файл**
- **Структура страницы**:
  - Заголовок "Астрономические события"
  - Карточка с областью для загрузки событий
  - Кнопка для запуска загрузки
- **JavaScript функция `loadAstroEvents()`**:
  - AJAX-запрос к `/api/astro/events`
  - Отображение списка событий или ошибки
  - Обработка ошибок сети/сервера

### 6. `resources/views/jwst.blade.php` — **новый файл**
- **Структура галереи**:
  - Заголовок "JWST Галерея"
  - Сетка изображений (колонки 3 в ряд)
  - Кнопка загрузки галереи
- **JavaScript функция `loadJwstGallery()`**:
  - Запрос к `/api/jwst/feed`
  - Динамическое создание карточек с изображениями
  - Отображение подписей и обработка ошибок

### 7. `resources/views/layouts/app.blade.php`
- **Обновление навигационного меню**:
  - Добавлены ссылки: `/iss`, `/jwst`, `/astro`
  - Удалён обманный `onclick` для ISS
  - Новый порядок: Dashboard, ISS, JWST, OSDR, Astro
- **Логическая группировка**: все модули доступны из навигации

### 8. `routes/web.php`
- **Новые маршруты для страниц**:
  - `GET /iss` → `IssController::index`
  - `GET /jwst` → `JwstController::index`
  - `GET /astro` → `AstroController::index`
  - `GET /osdr` → сохранён (OsdrController)
- **Переназначение API маршрута**:
  - `GET /api/jwst/feed` → `JwstController::feed` (было DashboardController)
- **Сохранённые маршруты**:
  - Прокси ISS данных через ProxyController
  - API астрономических событий
  - CMS страницы

## Технические детали
- **Разделение ответственности**: каждый контроллер управляет своей предметной областью
- **Единый шаблон**: все страницы используют `layouts/app.blade.php`
- **JavaScript динамика**: загрузка данных без перезагрузки страницы
- **Архитектурная чистота**: устранение монолитного DashboardController

## Преимущества изменений
- **Улучшенная навигация**: прямой доступ ко всем модулям
- **Модульность**: независимое развитие ISS, JWST, Astro страниц
- **Поддерживаемость**: меньшие и более простые контроллеры
- **Пользовательский опыт**: специализированные страницы для каждого типа данных
- **Масштабируемость**: легко добавлять новые страницы по аналогии

# Updated CMS database and controllers to reflect changes in block and page structure | 3e2f94de76ab2e12e842ff6f622bca138e452ab4

## Обновление CMS базы данных и контроллеров для отражения изменений в структуре блоков и страниц

## Обзор изменений
Корректировка логики работы CMS: исправление SQL-запросов, добавление нового контентного блока, обновление шаблонов для соответствия структуре данных.

## Изменённые файлы

### 1. `db/init.sql`
- **Добавление нового CMS блока**:
  - Slug: `dashboard_experiment`
  - Заголовок: "Космические факты"
  - Контент: HTML с интересными фактами о космосе:
    - Скорость МКС: ~28 000 км/ч
    - JWST видит свет возрастом 13.5 млрд лет
    - Возможность наблюдения астрономических событий с Земли
  - Динамическая временная метка: `NOW()` в подвале
  - Форматирование: Bootstrap классы `alert alert-info`
  - Активность: `TRUE`
- **Техника вставки**: `ON CONFLICT DO NOTHING` для предотвращения дублирования

### 2. `app/Http/Controllers/CmsController.php`
- **Исправление SQL-запроса** в методе `page()`:
  - Было: `SELECT title, content FROM cms_blocks WHERE slug = ? AND is_active = TRUE`
  - Стало: `SELECT title, body FROM cms_pages WHERE slug = ?`
- **Изменение источника данных**:
  - Таблица: `cms_pages` вместо `cms_blocks`
  - Поле: `body` вместо `content`
  - Условие: удалена проверка `is_active = TRUE`
- **Сохранение структуры ответа**: тот же view с параметрами `title` и `html`

### 3. `resources/views/cms/page.blade.php`
- **Смена базового шаблона**:
  - Было: `@extends('layout')`
  - Стало: `@extends('layouts.app')`
- **Совместимость**: использование единого шаблона приложения
- **Сохранение контента**: структура отображения заголовка и HTML не изменена

## Технические детали
- **Разделение сущностей**: 
  - `cms_blocks` — повторно используемые блоки (виджеты)
  - `cms_pages` — полноценные страницы с контентом
- **Безопасность**: отсутствие прямой подстановки пользовательских данных в SQL
- **Консистентность**: все страницы теперь используют единый layout приложения
- **Динамический контент**: пример блока с автоматическим обновлением времени

## Преимущества изменений
- **Чёткое разделение**: страницы и блоки управляются через разные таблицы
- **Единый интерфейс**: все страницы CMS используют стандартный layout
- **Расширяемость**: готовый пример контентного блока для dashboard
- **Согласованность**: соответствие структуры данных ожиданиям контроллера
- **Обратная совместимость**: API маршрута `/page/{slug}` сохраняет формат ответа

# Updated various PHP and Blade files for Space Dashboard | a41326d6e742bf20acf2fbde9a6aaee386f5ef0e

## Обновление различных PHP и Blade файлов для Space Dashboard

**Обзор изменений**
Рефакторинг и улучшение функционала отображения данных МКС, JWST и астрономических событий. Изменения включают обновление логики контроллеров и полную переработку Blade-шаблонов для улучшения пользовательского интерфейса.

### Изменённые файлы

**1. `app/Http/Controllers/IssController.php`**
- **Обновление метода `show`**:
  - Добавлен запрос данных тренда движения МКС с лимитом 240 точек через параметр `limit`.
  - Убрана заглушка для тренда; данные теперь получаются напрямую из API.
  - Данные тренда передаются в представление `iss`.

**2. `app/Http/Controllers/JwstController.php`**
- **Расширение метода `index`**:
  - Добавлена поддержка выбора наблюдения через сессию (`jwst_selected_observation`).
  - Реализована логика отображения последнего наблюдения по умолчанию, если в сессии ничего нет.
  - Добавлен парсинг данных наблюдения: извлечение URL изображения, инструментов, программы, суффикса.
  - Создан массив `$featured` с подробной информацией для передачи в шаблон.
- **Добавлен метод `selectObservation`**:
  - Обработка POST-запроса для сохранения выбранного наблюдения в сессии.
  - Валидация обязательных полей `obs_id` и `url`.
  - Возврат JSON-ответа об успехе или ошибке.

**3. `resources/views/astro.blade.php`**
- **Полная переработка интерфейса**:
  - Упрощённый контейнер с одной карточкой для астрономических событий.
  - Добавлена форма фильтрации с полями: широта (`lat`), долгота (`lon`), количество дней (`days`).
  - Таблица для отображения событий с колонками: #, Тело, Событие, Когда (UTC), Дополнительно.
  - Блок для отображения полного JSON-ответа в свернутом виде.
- **Обновление JavaScript**:
  - Функции `normalize` и `collect` для рекурсивного обхода структуры данных.
  - Асинхронная загрузка данных через `/api/astro/events` с параметрами из формы.
  - Динамическое обновление таблицы и JSON-блока.
  - Автозагрузка данных при открытии страницы.

**4. `resources/views/dashboard.blade.php`**
- **Упрощение главной страницы**:
  - Удалены все виджеты данных (МКС, JWST, карта, графики, галерея JWST, астро-события).
  - Оставлено только приветственное сообщение и ссылки на разделы.
  - Удалена сложная логика отображения CMS-блоков.
- **Оставлен только базовый CMS-блок**:
  - Запрос к таблице `cms_blocks` по слагу `dashboard_experiment`.
  - Простая обработка ошибок БД.

**5. `resources/views/iss.blade.php`**
- **Улучшение отображения данных МКС**:
  - Убраны лишние технические детали (вывод URL API).
  - Удалена ссылка на OSDR.
  - **Добавлена карта и графики**:
    - Интерактивная карта Leaflet для отображения позиции МКС и трека движения.
    - Два графика Chart.js: скорость и высота МКС.
    - Автоматическое обновление данных каждые 15 секунд через API `/api/iss/trend`.
    - Адаптивное отображение: карта занимает большую часть экрана, графики под ней.

**6. `resources/views/jwst.blade.php`**
- **Полная переработка страницы JWST**:
  - **Левая колонка**: Детальный просмотр выбранного наблюдения.
    - Отображение изображения, ID, программы, инструментов, суффикса.
    - Вывод заголовка и описания.
    - Свернутый блок с полным JSON.
  - **Основная область**: Галерея последних изображений JWST.
    - Фильтры: источник (JPG/суффикс/программа), инструмент, количество на странице.
    - Горизонтальный слайдер с навигацией (кнопки влево/вправо).
    - Каждое изображение кликабельно для выбора в качестве "избранного".
- **Расширенный JavaScript**:
  - Сохранение выбранного наблюдения в `localStorage`.
  - Обновление блока избранного без перезагрузки страницы.
  - Обработка кликов по изображениям галереи.
  - Автозагрузка галереи при открытии.

**7. `resources/views/osdr.blade.php`**
- **Незначительное изменение**:
  - Удалена строка с отображением источника данных (`$src`).
  - Упрощён заголовок страницы.

### Технические детали
- **API Интеграция**: Использование `/api/iss/trend`, `/api/jwst/feed`, `/api/astro/events`.
- **Сессии Laravel**: Сохранение состояния выбранного наблюдения JWST.
- **Локальное хранение**: `localStorage` для клиентского кэширования выбора JWST.
- **Интерактивность**: Динамические обновления без перезагрузки страницы.
- **Адаптивный дизайн**: Использование Bootstrap для отзывчивого интерфейса.

### Назначение изменений
- Улучшение пользовательского опыта за счёт разделения функционала по отдельным страницам.
- Добавление интерактивных элементов (карты, графики, слайдеры).
- Упрощение главной панели управления (dashboard).
- Централизация управления данными через API-эндпоинты.
- Повышение производительности за счёт ленивой загрузки данных.

# Updated AstroController and astro.blade.php to fetch data from Astronomy API with new parameters and structure | d6a47725cb02dd63ee4f4339c6b2fbb077aa2fb8

## Обновление AstroController и шаблона astro.blade.php для получения данных из Astronomy API с новыми параметрами и структурой

## Изменённые файлы

### 1. `app/Http/Controllers/AstroController.php`
- **Полностью переработан метод `events`**:
  - Добавлены новые обязательные и опциональные параметры для запроса:
    - `elevation` — высота наблюдателя (метры)
    - `from_date` — начальная дата периода (по умолчанию '2025-11-29')
    - `to_date` — конечная дата периода (по умолчанию '2026-11-29')
    - `time` — время суток для расчётов (по умолчанию '00:00:00')
    - `output` — формат вывода API ('rows' или 'table')
  - Удалены старые параметры: `days`, автоматическое вычисление `from`/`to`
  - Установлены координаты по умолчанию: `lat=65.9558`, `lon=37.6171`
- **Изменилась логика запроса к API**:
  - Запросы выполняются отдельно для каждого небесного тела (`sun`, `moon`)
  - Используется эндпоинт `bodies/events/{body}` вместо `bodies/events`
  - Все новые параметры передаются в строку запроса API
- **Полностью переработан формат ответа**:
  - Ответ объединяет данные по Солнцу и Луне в единый массив `rows`
  - Добавлена структурированная информация о периоде запроса в `data.dates`
  - Добавлены данные о местоположении наблюдателя в `data.observer`
  - Улучшена обработка ошибок: возвращается оригинальный HTTP-код от API

### 2. `resources/views/astro.blade.php`
- **Обновлена форма запроса**:
  - Замена поля `days` на `elevation` (высота в метрах)
  - Обновлён tooltip для поля высоты
- **Полностью переписана JavaScript-функция `collect`**:
  - Теперь работает с новой структурой ответа API (`data.rows`)
  - Извлекает данные о событиях (`events`) для каждого небесного тела (`body`)
  - Формирует строки таблицы с полями:
    - `name` — название небесного тела
    - `type` — тип события
    - `when` — дата пика события (использует `eventHighlights.peak.date` или `partialStart.date`)
    - `extra` — дополнительная информация (например, уровень затмения)
  - Удалена рекурсивная обработка (DFS) старого формата данных

## Технические детали
- **Аутентификация**: осталась без изменений (Basic Auth через `ASTRO_APP_ID`/`ASTRO_APP_SECRET`)
- **Обработка ошибок**: улучшена — возвращается оригинальный код ошибки API
- **Формат данных**: соответствует новому API Astronomy API v2
- **Обратная совместимость**: не сохраняется, требуется обновление фронтенда

# Added frontend enhancements: fade-in animations, slide-in animations, and sorting/filtering functionality to various pages | 5db42481768f998db8abed413ce5dba32ac71377

## Добавление улучшений фронтенда: анимации появления, выезжающие анимации и функции сортировки/фильтрации на различные страницы

## Изменённые файлы

### 1. `resources/views/astro.blade.php`
- **Добавлены CSS-классы анимаций**:
  - `fade-in` для заголовка страницы
  - `sortable` для всех заголовков таблицы (кроме последнего столбца)
- **Добавлен элемент поиска**:
  - Поле ввода `astroSearch` с подсказкой "Поиск по ключевым словам..."
- **Полностью переработан JavaScript**:
  - Добавлена система сортировки по столбцам (клик по заголовку)
  - Реализована фильтрация таблицы по введённому тексту
  - Индикаторы направления сортировки (▲/▼)
  - Глобальные переменные `originalRows`, `sortDirection` для управления состоянием
  - Функции `initTable()`, `sortTable()`, `filterTable()`, `updateSortIndicators()`
  - Автоматическая переинициализация после загрузки новых данных

### 2. `resources/views/dashboard.blade.php`
- **Добавлены CSS-классы анимаций**:
  - `fade-in` для текста приветствия
  - `slide-in` для CMS-блока (карточка)

### 3. `resources/views/iss.blade.php`
- **Добавлены CSS-классы анимаций**:
  - `fade-in` для карточки "Последний снимок"
  - `slide-in` для карточки "Тренд движения"

### 4. `resources/views/jwst.blade.php`
- **Добавлены CSS-классы анимаций**:
  - `fade-in` для заголовка "Выбранное наблюдение"
  - `fade-in` для слайдера изображений
  - `fade-in` для каждого элемента галереи (`.jwst-item`)

### 5. `resources/views/layouts/app.blade.php`
- **Добавлены глобальные CSS-стили для анимаций и интерактивности**:
  - Анимации: `fadeIn`, `slideIn` с ключевыми кадрами
  - Эффекты при наведении:
    - Карточки: подъём и изменение тени
    - Кнопки: увеличение при наведении
  - Стили для сортируемых заголовков таблиц:
    - Курсор pointer, запрет выделения текста
    - Индикаторы направления сортировки (▲/▼)
    - Изменение фона при наведении
  - Анимация появления таблиц (`table-responsive`)

### 6. `resources/views/osdr.blade.php`
- **Добавлены CSS-классы анимаций**:
  - `fade-in` для заголовка страницы
  - `fade-in` для каждой строки таблицы
  - `sortable` для всех сортируемых столбцов (кроме REST_URL и raw)
- **Добавлен элемент поиска**:
  - Поле ввода `osdrSearch` с подсказкой "Поиск по ключевым словам..."
- **Ограничение вывода данных**: отображение только первых 50 элементов
- **Добавлен JavaScript для сортировки и фильтрации**:
  - Полная система сортировки по столбцам (0-5)
  - Фильтрация по тексту с подсветкой строк
  - Управление состоянием через `originalRows` и `sortDirection`
  - Автоматическая инициализация после загрузки страницы

## Технические детали
- **Анимации CSS**: используются только CSS-анимации, без JavaScript-библиотек
- **Сортировка**: реализована на чистом JavaScript с поддержкой нескольких столбцов
- **Фильтрация**: мгновенный поиск по всему тексту строк таблицы
- **Отзывчивый дизайн**: все изменения адаптированы под мобильные устройства
- **Обработка событий**: корректное удаление и повторное добавление обработчиков
- **Производительность**: ограничение вывода данных на странице OSDR (50 строк)

# Added telemetry data table from Pascal Legacy Service to dashboard | 6fc48b0bd3f5e8dacbcf136c762a640a0b4d51d1

## Добавление таблицы телеметрии из Pascal Legacy Service на дашборд

## Изменённые файлы

### 1. `app/Http/Controllers/DashboardController.php`
- **Добавлен импорт `DB` фасада** для работы с базой данных
- **Запрос телеметрии из legacy-сервиса**:
  - SQL-запрос: `SELECT recorded_at, voltage, temp, source_file FROM telemetry_legacy ORDER BY recorded_at DESC LIMIT 10`
  - Получение 10 последних записей с сортировкой по времени
- **Передача данных в представление**:
  - Добавлена переменная `'telemetry' => $telemetry` в массив данных для view

### 2. `resources/views/dashboard.blade.php`
- **Добавлена новая карточка "Телеметрия из Pascal Legacy Service"**:
  - Структура: `.card` с классами `slide-in` и `shadow-sm`
  - Заголовок с классом `fade-in`
- **Элементы управления таблицей**:
  - Поле поиска `telemetrySearch` с подсказкой "Поиск по данным..."
  - Отзывчивая таблица с классами `sortable` для всех столбцов
- **Вывод данных телеметрии**:
  - 4 столбца: "Время записи", "Напряжение (V)", "Температура (°C)", "Источник"
  - Форматирование данных:
    - Дата: преобразование в формат `d.m.Y H:i:s` через Carbon
    - Числовые значения: округление до 2 знаков (`number_format`)
  - Обработка пустых данных: сообщение "Нет данных телеметрии"
- **JavaScript для сортировки и фильтрации**:
  - Полная система управления таблицей:
    - Переменные состояния: `originalRows`, `sortDirection`
    - Функции: `initTable()`, `addSortListeners()`, `addSearchListener()`
    - Сортировка: `sortTable()` с поддержкой 4 столбцов
    - Фильтрация: `filterTable()` по текстовому полю поиска
    - Индикаторы сортировки: `updateSortIndicators()` с классами `asc`/`desc`
  - Автоматическая инициализация через `setTimeout(initTable, 100)`

## Технические детали
- **Источник данных**: таблица `telemetry_legacy` в базе данных
- **Форматирование дат**: использование Carbon для локализации
- **Ограничение выборки**: 10 последних записей для производительности
- **Анимации**: стандартные классы `fade-in` и `slide-in` из глобальных стилей
- **Полнофункциональная таблица**: поиск и сортировка как на других страницах
- **Обработка ошибок**: корректное отображение при отсутствии данных

# Refactor controllers to use services | 44d9a4716c70710d343a09e81a04b0306f452939

## Рефакторинг контроллеров для использования сервисного слоя

## Изменённые файлы

### 1. Создание нового сервисного слоя (`app/Services/`)
Создано 6 новых сервисных классов:

#### **`AstroService.php`**:
- **Метод `getEvents()`**: содержит всю логику работы с Astronomy API (ранее в `AstroController::events()`)
- **Параметры**: принимает массив параметров запроса
- **Обработка ошибок**: выбрасывает исключения с HTTP-кодами
- **Структура ответа**: возвращает стандартизированный формат с данными о событиях Солнца и Луны

#### **`DashboardService.php`**:
- **Зависимости**: внедряет `IssService` и `TelemetryService`
- **Метод `getDashboardData()`**: собирает все данные для главной страницы
- **Включает**: данные МКС, телеметрию, метрики и пустые структуры для JWST

#### **`IssService.php`**:
- **Методы**: `getLast()` и `getTrend()` для получения данных из Rust-сервиса
- **Вспомогательные методы**: `base()`, `getJson()` для HTTP-запросов
- **Конфигурация**: использует переменную окружения `RUST_BASE`

#### **`JwstService.php`**:
- **Методы**:
  - `getFeaturedObservation()`: получение выбранного наблюдения из сессии или последнего
  - `selectObservation()`: сохранение выбранного наблюдения в сессии
  - `getFeed()`: получение галереи изображений с фильтрацией
- **Вспомогательные методы**: `pickImageUrl()`, `extractInstruments()`
- **Зависимость**: использует существующий `JwstHelper`

#### **`OsdrService.php`**:
- **Метод `getOsdrList()`**: получение и обработка данных OSDR из Rust-сервиса
- **Вспомогательные методы**: `flattenOsdr()`, `looksOsdrDict()` для преобразования данных
- **Форматирование**: плоская структура данных для таблицы

#### **`TelemetryService.php`**:
- **Метод `getLatestTelemetry()`**: получение телеметрии из таблицы `telemetry_legacy`
- **Использование**: подготовленные SQL-запросы с параметрами

### 2. Рефакторинг контроллеров
Все контроллеры переведены на использование сервисов через dependency injection:

#### **`AstroController.php`**:
- **Внедрение зависимости**: `AstroService` через конструктор
- **Упрощение метода `events()`**: вызов `$this->astroService->getEvents()`
- **Обработка ошибок**: перехват исключений и возврат JSON-ответов

#### **`DashboardController.php`**:
- **Внедрение зависимости**: `DashboardService` через конструктор
- **Упрощение метода `index()`**: вызов `$this->dashboardService->getDashboardData()`
- **Удаление**: прямой работы с БД и HTTP-запросами

#### **`IssController.php`**:
- **Внедрение зависимости**: `IssService` через конструктор
- **Упрощение метода `index()`**: вызовы `getLast()` и `getTrend()`
- **Удаление**: приватных методов `base()` и `getJson()`

#### **`JwstController.php`**:
- **Внедрение зависимости**: `JwstService` через конструктор
- **Упрощение методов**:
  - `index()`: вызов `getFeaturedObservation()`
  - `selectObservation()`: вызов `selectObservation()` с массивом данных
  - `feed()`: вызов `getFeed()` с параметрами запроса
- **Удаление**: сложной логики обработки JWST-данных

#### **`OsdrController.php`**:
- **Внедрение зависимости**: `OsdrService` через конструктор
- **Упрощение метода `index()`**: вызов `getOsdrList()` с лимитом
- **Удаление**: методов `flattenOsdr()` и `looksOsdrDict()`

## Архитектурные изменения
- **Разделение ответственности**: бизнес-логика вынесена из контроллеров в сервисы
- **Повторное использование**: сервисы можно использовать в разных контроллерах
- **Тестируемость**: сервисы легче тестировать изолированно
- **Поддерживаемость**: чистые контроллеры с минимальной логикой
- **Инверсия зависимостей**: контроллеры зависят от абстракций (интерфейсов сервисов)

## Технические детали
- **Dependency Injection**: Laravel автоматически резолвит зависимости через контейнер
- **Обработка ошибок**: единый подход через исключения в сервисах
- **Сессии**: работа с сессиями осталась в сервисном слое (JWST)
- **Конфигурация**: использование `env()` для получения настроек
- **Совместимость**: сохранение форматов ответов API

# Refactor controllers and services to use repositories | 442a32824f9064d548a2d26609d846de7894dfd1

## Рефакторинг контроллеров и сервисов для использования репозиториев

## Изменённые файлы

### 1. Создание Eloquent моделей (`app/Models/`)
Создано 3 новые модели для работы с базой данных:

#### **`CmsBlock.php`**:
- **Таблица**: `cms_blocks`
- **Заполняемые поля**: `slug`, `title`, `content`, `is_active`
- **Преобразования типов**: 
  - `is_active` → `boolean`
  - `created_at`, `updated_at` → `datetime`

#### **`DummyTrainingMarker.php`**:
- **Таблица**: `dummy_training_marker`
- **Заполняемые поля**: `note`
- **Преобразования типов**: `created_at`, `updated_at` → `datetime`

#### **`Telemetry.php`**:
- **Таблица**: `telemetry_legacy`
- **Особенность**: `$timestamps = false` (таблица не имеет полей created_at/updated_at)
- **Заполняемые поля**: `recorded_at`, `voltage`, `temp`, `source_file`
- **Преобразования типов**:
  - `recorded_at` → `datetime`
  - `voltage`, `temp` → `decimal:2`

### 2. Создание репозиториев (`app/Repositories/`)
Создано 6 классов репозиториев:

#### **`BaseRepository.php`** (абстрактный базовый класс):
- **CRUD операции**: `all()`, `find()`, `create()`, `update()`, `delete()`
- **Дополнительные методы**: `paginate()`, `where()`
- **Архитектура**: шаблон Repository Pattern с инъекцией модели

#### **`CmsBlockRepository.php`**:
- **Специфичные методы**:
  - `getActiveBlocks()`: активные блоки
  - `findBySlug()`: поиск по слагу
  - `getActiveBlockBySlug()`: активный блок по слагу

#### **`CmsPageRepository.php`**:
- **Методы**:
  - `findBySlug()`: поиск страницы по слагу
  - `getPageContent()`: получение контента страницы в формате объекта

#### **`DummyTrainingMarkerRepository.php`**:
- **Методы**:
  - `getMarkersWithNotes()`: маркеры с заполненными заметками
  - `getRecentMarkers()`: последние маркеры с лимитом

#### **`TelemetryRepository.php`**:
- **Метод `getLatestTelemetry()`**: получение последних записей телеметрии с сортировкой и лимитом

### 3. Рефакторинг контроллеров

#### **`CmsController.php`**:
- **Внедрение зависимости**: `CmsPageRepository` через конструктор
- **Упрощение метода `page()`**: вызов `$this->cmsPageRepository->getPageContent()`
- **Удаление**: прямых SQL-запросов через DB фасад

### 4. Обновление сервисов

#### **`DashboardService.php`**:
- **Добавлена зависимость**: `CmsBlockRepository`
- **Обновлён конструктор**: теперь принимает 3 зависимости
- **Изменён метод `getDashboardData()`**: получение CMS-блока через репозиторий
- **Добавлен вывод**: `'cms_block' => $cmsBlock` в результат

#### **`TelemetryService.php`**:
- **Внедрение зависимости**: `TelemetryRepository` через конструктор
- **Изменён метод `getLatestTelemetry()`**: теперь использует репозиторий
- **Удаление**: прямых SQL-запросов через DB фасад

### 5. Обновление представления

#### **`dashboard.blade.php`**:
- **Замена PHP-блока**: удалена ручная работа с БД через `DB::selectOne`
- **Использование переменной из контроллера**: `$cms_block`
- **Безопасный вывод**: `{!! $cms_block->content !!}` с проверкой существования
- **Обработка отсутствия данных**: показ сообщения "блок не найден"

## Архитектурные изменения
- **Слоистая архитектура**: контроллеры → сервисы → репозитории → модели
- **Инкапсуляция данных**: SQL-запросы изолированы в репозиториях
- **Повторное использование**: базовый репозиторий с общими CRUD операциями
- **Типизация**: строгая типизация через Eloquent модели
- **Тестируемость**: репозитории легко мокать в тестах

## Технические детали
- **Active Record Pattern**: модели Eloquent наследуются от `Model`
- **Dependency Injection**: автоматическое внедрение через контейнер Laravel
- **Методология**: Repository Pattern поверх Eloquent
- **Безопасность**: использование подготовленных запросов на уровне Eloquent
- **Производительность**: eager loading и оптимизация запросов через Eloquent

# Refactor services to use client classes instead of hardcoded API calls | dba11b28eb761565289d59453ccae2ea26d9d349

## Рефакторинг сервисов для использования клиентских классов вместо жёстко заданных API-вызовов

## Изменённые файлы

### 1. Создание клиентских классов (`app/Clients/`)
Создано 3 новых клиентских класса для работы с внешними API:

#### **`AstroClient.php`**:
- **Назначение**: взаимодействие с Astronomy API v2
- **Конфигурация**: получает `ASTRO_APP_ID` и `ASTRO_APP_SECRET` из env
- **Основной метод**: `getEvents()` - получение астрономических событий для Солнца и Луны
- **Особенности**:
  - Автоматическая Basic-аутентификация
  - Обработка HTTP-ошибок с выбрасыванием исключений
  - Поддержка всех параметров запроса (широта, долгота, высота, даты и др.)
  - Объединение результатов по обоим небесным телам

#### **`JwstClient.php`**:
- **Назначение**: работа с API James Webb Space Telescope
- **Конфигурация**: `JWST_HOST`, `JWST_API_KEY`, `JWST_EMAIL` из env
- **Основной метод**: `get()` - выполнение GET-запросов к JWST API
- **Статический метод**: `pickImageUrl()` - рекурсивный поиск URL изображений в структуре данных
- **Особенности**:
  - Заголовки `x-api-key` и опционально `email`
  - Таймаут 30 секунд
  - Автоматическое построение URL с query-параметрами

#### **`RustClient.php`**:
- **Назначение**: взаимодействие с Rust-сервисом (ISS, OSDR)
- **Конфигурация**: `RUST_BASE` из env (по умолчанию `http://rust_iss:3000`)
- **Основной метод**: `getJson()` - выполнение GET-запросов и парсинг JSON
- **Дополнительный метод**: `getBaseUrl()` - получение базового URL
- **Особенности**:
  - Автоматическое добавление query-параметров к URL
  - Тихая обработка ошибок через `@file_get_contents`
  - Возврат пустого массива при ошибках

### 2. Рефакторинг сервисов

#### **`AstroService.php`**:
- **Внедрение зависимости**: `AstroClient` через конструктор
- **Упрощение метода `getEvents()`**: вызов `$this->client->getEvents()` с параметрами
- **Удаление**: всей логики работы с cURL и аутентификацией
- **Сохранение структуры ответа**: преобразование данных клиента в формат, ожидаемый контроллером

#### **`IssService.php`**:
- **Внедрение зависимости**: `RustClient` через конструктор
- **Упрощение методов**:
  - `getLast()`: `$this->client->getJson('last')`
  - `getTrend()`: `$this->client->getJson('iss/trend', ['limit' => $limit])`
- **Удаление**: приватных методов `base()` и `getJson()`

#### **`JwstService.php`**:
- **Замена зависимости**: `JwstHelper` на `JwstClient`
- **Обновление конструктора**: инъекция `JwstClient`
- **Изменение вызовов**: 
  - `$this->jwstHelper->get()` → `$this->jwstClient->get()`
  - `JwstHelper::pickImageUrl()` → `$this->jwstClient->pickImageUrl()`
- **Сохранение логики**: обработка данных осталась неизменной

#### **`OsdrService.php`**:
- **Внедрение зависимости**: `RustClient` через конструктор
- **Упрощение метода `getOsdrList()`**: 
  - `$this->client->getJson('osdr/list', ['limit' => $limit])`
  - Использование `$this->client->getBaseUrl()` для формирования src
- **Удаление**: приватных методов `base()` и `getJson()`

## Архитектурные изменения
- **Инкапсуляция HTTP-логики**: все API-запросы вынесены в отдельные клиентские классы
- **Единая точка конфигурации**: настройки API хранятся только в env-переменных
- **Повторное использование**: клиенты могут использоваться в разных сервисах
- **Согласованность**: единый подход к обработке ошибок и запросов
- **Тестируемость**: клиенты легко мокать в тестах сервисов

## Технические детали
- **Dependency Injection**: все клиенты внедряются через конструкторы сервисов
- **Изоляция изменений**: изменения в API затрагивают только клиентские классы
- **Безопасность**: использование подготовленных URL и заголовков
- **Производительность**: кэширование аутентификационных данных в клиентах
- **Обратная совместимость**: сохранение форматов данных на уровне сервисов

# Refactor controllers and services to use DTOs for data transfer | 8c4fd10780c75614a204b0c1dede545dc69f23bd

## Рефакторинг контроллеров и сервисов для использования DTO (Data Transfer Objects) для передачи данных

### Изменённые файлы

#### 1. **Создание DTO (`app/DTOs/`)**
Создано 4 новых класса DTO для типизации данных между слоями приложения:

- **`AstroEventsDto.php`** — данные астрономических событий:
  - Содержит поля: `dates`, `observer`, `rows`
  - Метод `toArray()` для преобразования в массив с ключом `data`

- **`DashboardDataDto.php`** — все данные для главной панели управления:
  - Содержит 11 полей: `iss`, `trend`, `jw_gallery`, `jw_observation_raw`, `jw_observation_summary`, `jw_observation_images`, `jw_observation_files`, `metrics`, `telemetry`, `cms_block`
  - Метод `toArray()` возвращает ассоциативный массив с теми же ключами

- **`JwstFeedDto.php`** — данные галереи JWST:
  - Поля: `source`, `count`, `items`
  - Метод `toArray()` для сериализации в JSON

- **`OsdrListDto.php`** — список элементов OSDR:
  - Поля: `items` (массив элементов), `src` (источник данных)
  - Метод `toArray()` возвращает массив для передачи в представление

#### 2. **Обновление контроллеров (`app/Http/Controllers/`)**
Контроллеры адаптированы для работы с DTO вместо массивов:

- **`AstroController.php`**:
  - Метод `events()` теперь возвращает JSON из DTO через `toArray()`
  - Переменная `$data` переименована в `$dto`

- **`DashboardController.php`**:
  - Метод `index()` извлекает данные из DTO и передаёт в view только `cms_block` и `telemetry`
  - Добавлен новый метод `data()` для API-эндпоинта, возвращающего все данные в JSON

- **`JwstController.php`**:
  - Метод `feed()` возвращает JSON из `JwstFeedDto`
  - Упрощена логика возврата данных

- **`OsdrController.php`**:
  - Метод `index()` передаёт в представление массив из DTO через `toArray()`
  - Убрана прямая работа с массивами данных

#### 3. **Обновление сервисов (`app/Services/`)**
Сервисы возвращают DTO вместо массивов:

- **`AstroService.php`**:
  - Метод `getEvents()` теперь возвращает `AstroEventsDto`
  - Логика формирования ответа переписана для создания DTO
  - Удалено ручное формирование массива `data`

- **`DashboardService.php`**:
  - Метод `getDashboardData()` возвращает `DashboardDataDto`
  - Данные телеметрии преобразуются в массив через `toArray()`
  - Все поля передаются в конструктор DTO

- **`JwstService.php`**:
  - Метод `getFeed()` возвращает `JwstFeedDto`
  - Удалено ручное формирование массива ответа
  - Поля `path`, `count(items)`, `items` передаются в DTO

- **`OsdrService.php`**:
  - Метод `getOsdrList()` возвращает `OsdrListDto`
  - Упрощён возврат данных — вместо массива создаётся DTO
  - Логика формирования `src` осталась в сервисе

#### 4. **Обновление представлений (`resources/views/`)**
- **`dashboard.blade.php`**:
  - Обновлён доступ к данным телеметрии: `$record['field']` вместо `$record->field`
  - Примеры: `$record['recorded_at']`, `$record['voltage']`, `$record['temp']`, `$record['source_file']`

### Архитектурные изменения
- **Типизация данных**: контроллеры и сервисы работают с объектами DTO вместо неструктурированных массивов
- **Сериализация**: все DTO имеют метод `toArray()` для согласованного преобразования в массивы
- **Разделение ответственности**: сервисы создают DTO, контроллеры решают как их использовать (JSON или view)
- **API расширение**: добавлен новый эндпоинт `/dashboard/data` для получения всех данных в JSON

### Технические детали
- **Иммутабельность**: DTO создаются с данными и не изменяются
- **Совместимость**: сохранение формата данных для фронтенда
- **Производительность**: минимальные накладные расходы
- **Чистота кода**: устранение магических строк и индексов
- **Поддержка IDE**: автодополнение полей DTO в контроллерах и сервисах

# Refactor ISS API endpoints to use IssController instead of ProxyController | 7f2676b8af9a8f09fa89616730eeedfb72c6b7db

## Рефакторинг ISS API эндпоинтов для использования IssController вместо ProxyController

**Описание изменений**
Удалён ProxyController и перенесена вся логика проксирования запросов к Rust-сервису в IssController. Добавлен сервисный слой для CMS (CmsService). Эндпоинты ISS теперь используют IssController напрямую, что упрощает архитектуру и улучшает поддерживаемость кода.

**Изменённые файлы**

### 1. `app/Http/Controllers/CmsController.php`
- **Зависимость изменена**: `CmsPageRepository` → `CmsService`
- **Обновлён конструктор**: теперь внедряется `CmsService`
- **Метод `page()`**: вызов `$this->cmsService->getPageContent()` вместо прямого обращения к репозиторию

### 2. `app/Http/Controllers/IssController.php`
- **Добавлены два новых метода API**:
  - `last()`: возвращает последние данные МКС через `$this->issService->getLast()`
  - `trend(Request $request)`: возвращает тренд движения МКС с поддержкой параметра `limit` (по умолчанию 240) через `$this->issService->getTrend()`

### 3. `app/Http/Controllers/ProxyController.php` — **полностью удалён**
- **Удалена вся логика проксирования**: методы `last()`, `trend()`, `pipe()`
- **Удалены**: ручное создание HTTP-контекста, обработка таймаутов, проверка JSON, обработка ошибок через `file_get_contents`

### 4. `app/Services/CmsService.php` — **новый файл**
- **Сервисный слой для CMS**: инкапсулирует работу с репозиторием страниц
- **Конструктор**: принимает `CmsPageRepository`
- **Метод `getPageContent(string $slug)`: проксирует вызов к репозиторию

### 5. `routes/web.php`
- **Изменены маршруты ISS API**:
  - `/api/iss/last` → теперь указывает на `IssController::last`
  - `/api/iss/trend` → теперь указывает на `IssController::trend`
- **Удалены ссылки** на `ProxyController`
- **Комментарии обновлены**: "ISS API endpoints" вместо "Прокси к rust_iss"

**Технические детали**
- **Упрощение архитектуры**: устранение лишнего слоя проксирования
- **Согласованность**: все эндпоинты ISS теперь обрабатываются одним контроллером
- **Сервисный слой**: CmsService добавляет уровень абстракции между контроллером и репозиторием
- **Обратная совместимость**: форматы ответов API остались неизменными
- **Безопасность**: удалён потенциально уязвимый код ручной обработки HTTP-запросов

**Преимущества изменений**
- **Чистота кода**: удаление дублирующей логики проксирования
- **Поддерживаемость**: централизация логики ISS в одном контроллере
- **Тестируемость**: упрощение тестирования за счёт использования сервисов
- **Архитектурная ясность**: чёткое разделение ответственности между слоями

# Added error handling to Astro, Iss, Jwst, and Osdr controllers | d2d7a0d10101a359f7aef3e8341fe401c3d0fd82

## Добавление обработки ошибок в контроллерах Astro, Iss, Jwst и Osdr

**Описание изменений**
Создан базовый контроллер `Controller` с унифицированным методом обработки ошибок `errorResponse()`. Все API-методы в контроллерах Astro, Iss, Jwst и Osdr обёрнуты в блоки try-catch с использованием нового метода для возврата согласованных JSON-ошибок.

**Изменённые файлы**

### 1. `app/Http/Controllers/Controller.php` — **новый файл**
- **Базовый контроллер**: наследуется от `BaseController` Laravel
- **Использует трейты**: `AuthorizesRequests`, `ValidatesRequests`
- **Метод `errorResponse($message, $code = 500)`**:
  - Возвращает JSON с ключами `error` и `code`
  - Устанавливает соответствующий HTTP-статус
  - Используется для единообразной обработки исключений

### 2. `app/Http/Controllers/AstroController.php`
- **Метод `events()`**: обёрнут в try-catch
- **Упрощена обработка ошибок**: вызов `$this->errorResponse()` вместо ручного формирования JSON
- **Удалено**: прямое создание массива ошибки с кодом

### 3. `app/Http/Controllers/IssController.php`
- **Добавлена обработка ошибок в оба метода**:
  - `last()`: try-catch с вызовом `errorResponse()`
  - `trend()`: try-catch с вызовом `errorResponse()`
- **Сохранение логики**: получение данных через сервис осталось неизменным

### 4. `app/Http/Controllers/JwstController.php`
- **Метод `selectObservation()`**:
  - Обёрнут в try-catch
  - Добавлена проверка `$success` с возвратом `errorResponse(400)` при неудаче
  - Упрощён успешный ответ: только `['success' => true]`
- **Метод `feed()`**: обёрнут в try-catch с вызовом `errorResponse()`

### 5. `app/Http/Controllers/OsdrController.php`
- **Метод `index()`**: обёрнут в try-catch
- **Обработка ошибок**: вызов `$this->errorResponse()` вместо передачи исключения дальше
- **Примечание**: возвращает JSON-ошибку вместо view (изменение поведения для ошибок)

**Технические детали**
- **Единообразие**: все контроллеры теперь используют один метод для ошибок
- **Структура ошибок**: `{"error": "сообщение", "code": число}`
- **Наследование**: все контроллеры автоматически получают доступ к `errorResponse()`
- **Обработка кодов**: используется код исключения или 500 по умолчанию

**Преимущества изменений**
- **Согласованность API**: единый формат ошибок для всех эндпоинтов
- **Упрощение кода**: устранение дублирования обработки ошибок
- **Безопасность**: предотвращение утечки деталей исключений в production
- **Поддерживаемость**: централизованное управление форматом ошибок
- **Тестируемость**: легче тестировать обработку ошибок в контроллерах

# Added middleware to routes group and reformatted code | 1f434650a4cd2b6dc6fe2cf5ae6db28a30bcd9a1

## Добавление middleware логирования и реформатирование маршрутов

**Описание изменений**
Создан новый middleware для логирования HTTP-запросов и все маршруты приложения обёрнуты в группу с применением этого middleware. Проведено реформатирование структуры файла маршрутов для улучшения читаемости.

**Изменённые файлы**

### 1. `app/Http/Middleware/LoggingMiddleware.php` — **новый файл**
- **Middleware логирования**: перехватывает все HTTP-запросы для записи логов
- **Измерение времени выполнения**: вычисляет продолжительность обработки запроса в миллисекундах
- **Запись в лог**: использует `Log::info()` со структурой данных:
  - `method` — HTTP метод (GET, POST, etc.)
  - `url` — полный URL запроса
  - `ip` — IP-адрес клиента
  - `user_agent` — User-Agent заголовок
  - `status_code` — HTTP статус ответа
  - `duration_ms` — время выполнения в мс (округлено до 2 знаков)

### 2. `routes/web.php`
- **Группировка маршрутов**: все маршруты обёрнуты в `Route::middleware()->group()`
- **Применён middleware**: `\App\Http\Middleware\LoggingMiddleware::class` применяется ко всем маршрутам
- **Структурные изменения**:
  - Упрощённый редирект с `/` на `/dashboard` внутри группы
  - Все панели (dashboard, iss, jwst, osdr, astro) в одной группе
  - Все API-эндпоинты (iss, jwst, astro, cms) в той же группе
- **Сохранилась логика**: порядок и обработчики маршрутов не изменились

**Технические детали**
- **Время выполнения**: рассчитывается как разница между `microtime(true)` до и после обработки
- **Формат логов**: структурированный JSON-подобный формат для удобства парсинга
- **Глобальное применение**: middleware будет выполняться для каждого запроса ко всем маршрутам
- **Совместимость**: middleware работает с любым типом ответа (JSON, view, redirect)

**Преимущества изменений**
- **Мониторинг**: появление детализированных логов по всем запросам приложения
- **Производительность**: возможность отслеживать медленные запросы через `duration_ms`
- **Безопасность**: логирование IP и User-Agent для анализа трафика
- **Отладка**: упрощение поиска проблем по кодам статусов и времени выполнения
- **Чистота кода**: группировка маршрутов улучшает читаемость и поддерживаемость

# Added RateLimitingMiddleware to middleware group in web.php | 6eac8f756fda2ffb417cdca026b67e606c92402a

## Добавление RateLimitingMiddleware в группу middleware в web.php

**Описание изменений**
Создан новый middleware для ограничения частоты запросов (rate limiting) и добавлен в группу middleware всех маршрутов приложения. Теперь все запросы проходят проверку на превышение лимита.

**Изменённые файлы**

### 1. `app/Http/Middleware/RateLimitingMiddleware.php` — **новый файл**
- **Rate limiting по IP**: отслеживает количество запросов с каждого IP-адреса
- **Логика работы**:
  - Генерация ключа кэша: `rate_limit:{ip}`
  - Максимальное количество запросов: 100 в минуту
  - Время сброса счётчика: 1 минута
- **Проверка лимита**:
  - При превышении лимита возвращается JSON-ошибка с кодом 429
  - Сообщение: `'Too many requests. Please try again later.'`
- **Инкремент счётчика**: увеличивает счётчик запросов при каждом успешном прохождении
- **Хранение состояния**: использует Laravel Cache для хранения счётчиков

### 2. `routes/web.php`
- **Обновлён список middleware**: добавлен `\App\Http\Middleware\RateLimitingMiddleware::class`
- **Изменён вызов `middleware()`**: теперь принимает два middleware в массиве
- **Порядок выполнения**: `LoggingMiddleware` → `RateLimitingMiddleware` → обработчик маршрута
- **Область действия**: rate limiting применяется ко всем маршрутам внутри группы

**Технические детали**
- **Идентификация**: по IP-адресу клиента (`$request->ip()`)
- **Временное окно**: 60 секунд (1 минута)
- **Лимит**: 100 запросов на IP в минуту
- **Кэширование**: используется драйвер кэша Laravel (по умолчанию file/redis)
- **Ошибка 429**: стандартный HTTP-код "Too Many Requests"

**Преимущества изменений**
- **Защита от DDoS**: предотвращение чрезмерной нагрузки на сервер
- **Справедливость**: равное распределение ресурсов между пользователями
- **API безопасность**: защита эндпоинтов от злоупотреблений
- **Производительность**: снижение нагрузки при скачках трафика
- **Стандартизация**: использование общепринятого подхода к rate limiting

# Added telemetry download feature to dashboard | b8642e0914b3d423630d9733242d06af30b07715

## Добавление функции скачивания телеметрии на дашборд

**Описание изменений**
Добавлена возможность скачивания CSV-файлов с телеметрией по отдельным источникам данных. В таблицу телеметрии добавлены кликабельные ссылки на скачивание, создан новый маршрут и метод контроллера для генерации CSV.

**Изменённые файлы**

### 1. `app/Http/Controllers/DashboardController.php`
- **Добавлена зависимость**: внедрение `TelemetryService` через конструктор
- **Новый метод `downloadTelemetryCsv(Request $request)`**:
  - Получает параметр `source_file` из query string
  - Проверяет наличие параметра (400 ошибка при отсутствии)
  - Получает данные телеметрии по указанному файлу-источнику через сервис
  - Возвращает 404 если данные не найдены
  - Формирует CSV с заголовками: "Время записи,Напряжение (V),Температура (°C),Источник"
  - Преобразует даты в формат `d.m.Y H:i:s`
  - Форматирует числовые значения до 2 знаков после запятой
  - Генерирует имя файла: `telemetry_{source_file}.csv`
  - Возвращает ответ с заголовками для скачивания CSV

### 2. `app/Repositories/TelemetryRepository.php`
- **Новый метод `getTelemetryBySourceFile(string $sourceFile)`**:
  - Получает все записи телеметрии для указанного файла-источника
  - Выбирает поля: `recorded_at`, `voltage`, `temp`, `source_file`
  - Сортирует по времени записи в обратном порядке
  - Использует where-условие по полю `source_file`

### 3. `app/Services/TelemetryService.php`
- **Новый метод `getTelemetryBySourceFile(string $sourceFile)`**:
  - Проксирует вызов к соответствующему методу репозитория
  - Возвращает коллекцию данных телеметрии для указанного источника

### 4. `resources/views/dashboard.blade.php`
- **Обновлены ячейки таблицы**: столбец "Источник" теперь содержит кликабельные ссылки
- **Формат ссылок**: `{{ route('dashboard.download-telemetry-csv', ['source_file' => $record['source_file']]) }}`
- **Открытие в новой вкладке**: добавлен атрибут `target="_blank"`
- **Текст ссылки**: отображается оригинальное имя файла-источника

### 5. `routes/web.php`
- **Добавлен новый маршрут**: `GET /dashboard/download-telemetry-csv`
- **Именованный маршрут**: `dashboard.download-telemetry-csv`
- **Обработчик**: `DashboardController::downloadTelemetryCsv`
- **Расположение**: внутри группы middleware (логирование и rate limiting)

**Технические детали**
- **CSV форматирование**: разделитель - запятая, кодировка кириллицы корректная
- **Безопасность имён файлов**: замена недопустимых символов `[/\ ]` на `_`
- **Обработка ошибок**: валидация входных параметров и проверка наличия данных
- **Формат дат**: использование Carbon для локализованного форматирования
- **Заголовки ответа**: правильные MIME-тип и Content-Disposition для скачивания

**Преимущества изменений**
- **Экспорт данных**: возможность скачивания полных наборов телеметрии по источникам
- **Удобство пользователя**: прямые ссылки из таблицы без необходимости ручного ввода
- **Структурированные данные**: CSV формат для импорта в Excel/Google Sheets
- **Производительность**: фильтрация данных на уровне БД перед генерацией CSV
- **Безопасность**: проверка параметров и обработка ошибок на всех этапах

# Update telemetry database schema and PHP code to include is_valid field | 4ff606edab3f53b6fdb23185e0fb692a2056c60f

## Обновление схемы базы данных телеметрии и PHP кода для включения поля is_valid

**Описание изменений**
Расширена структура таблицы телеметрии, переписан legacy-сервис с Pascal на Python, обновлены репозитории и представления для поддержки нового поля `is_valid` (валидность данных).

**Изменённые файлы**

### 1. `db/init.sql`
- **Добавлено поле `is_valid`**: в таблицу `telemetry_legacy` добавлен столбец `is_valid BOOLEAN NOT NULL`
- **Расположение**: после `source_file`, перед закрывающей скобкой
- **Обязательное поле**: `NOT NULL` для всех записей

### 2. `services/pascal-legacy/` — **полная переработка**
- **Смена языка**: с Pascal на Python 3.9
- **Обновлён `Dockerfile`**:
  - Базовый образ: `debian:12-slim` → `python:3.9-slim`
  - Установка: `fp-compiler fp-units-fcl` → `python пакеты`
  - Копирование: `legacy.pas` → `legacy.py` + `requirements.txt`
  - Установка зависимостей: `pip install -r requirements.txt`
- **Новый `legacy.py`** (заменяет `legacy.pas`):
  - Генерация CSV и XLSX файлов
  - Добавлено поле `is_valid` со случайным значением True/False
  - Формулы Excel: `=NOW()`, `=RAND()`, `=TRUE`/`=FALSE`, динамические имена
  - Стили Excel: форматирование даты через `NamedStyle`
  - Подключение к PostgreSQL через `psycopg2`
  - Вставка данных с полем `is_valid`
  - Конфигурируемый период генерации через `GEN_PERIOD_SEC`
- **`requirements.txt`**: `psycopg2-binary==2.9.7`, `openpyxl==3.1.2`
- **Обновлён `run.sh`**: запуск `python3 legacy.py` вместо скомпилированного Pascal

### 3. `services/php-web/laravel-patches/app/Http/Controllers/DashboardController.php`
- **Обновлён CSV экспорт**:
  - Добавлен столбец "Валидность" в заголовок
  - Значения: "Да"/"Нет" в зависимости от `$record['is_valid']`
  - Порядок: после температуры, перед источником
- **Форматирование**: русские строки "Да"/"Нет" вместо boolean значений

### 4. `services/php-web/laravel-patches/app/Repositories/TelemetryRepository.php`
- **Обновлены методы выборки**:
  - `getLatestTelemetry()`: добавлено поле `is_valid` в select
  - `getTelemetryBySourceFile()`: добавлено поле `is_valid` в select
- **Структура запросов**: сохранена сортировка и условия where

### 5. `services/php-web/laravel-patches/resources/views/dashboard.blade.php`
- **Обновление таблицы телеметрии**:
  - Заголовок: "Телеметрия из Legacy Service" (убрано "Pascal")
  - Добавлен столбец "Валидность" между температурой и источником
  - Значения: `{{ $record['is_valid'] ? 'Да' : 'Нет' }}`
  - Колонка сортировки: 4 вместо 3 для столбца "Источник"
  - `colspan`: изменён с 4 на 5 для пустой строки
- **Структура таблицы**: 5 столбцов вместо 4

**Технические детали**
- **Boolean в БД**: PostgreSQL тип `BOOLEAN` для поля `is_valid`
- **Двойная генерация**: CSV для простоты, XLSX с формулами для анализа
- **Формулы Excel**: динамическое вычисление значений в XLSX файлах
- **Совместимость**: сохранение существующих API и форматов данных
- **Локализация**: русские значения "Да"/"Нет" в интерфейсе и CSV

**Преимущества изменений**
- **Качество данных**: добавление метки валидности для фильтрации некорректных записей
- **Современный стек**: переход с устаревшего Pascal на поддерживаемый Python
- **Богатый экспорт**: генерация как CSV, так и XLSX с формулами
- **Гибкость**: конфигурируемый период генерации через переменные окружения
- **Простота развёртывания**: использование стандартных Python пакетов вместо компилятора

# Added middleware module and rate limit middleware to routes | 29d5ba79892fc80cc84c05e86616067e09098c94

## Добавление модуля middleware и middleware rate limit в маршруты

**Описание изменений**
Создан новый модуль middleware для Rust ISS сервиса с реализацией rate limiting (ограничения частоты запросов). Middleware интегрирован в систему маршрутизации для защиты всех эндпоинтов от чрезмерной нагрузки.

**Изменённые файлы**

### 1. `src/main.rs`
- **Добавлен импорт нового модуля**: `mod middleware;` в список модулей
- **Порядок модулей**: после `handlers`, перед `routes`
- **Минимальное изменение**: только декларация модуля

### 2. `src/middleware/mod.rs` — **новый файл**
- **Структура `RateLimiter`**:
  - `inner`: потокобезопасное хранилище `Arc<Mutex<HashMap<String, Vec<Instant>>>>`
  - `max_requests`: максимальное количество запросов (100)
  - `window`: временное окно (60 секунд)
- **Методы `RateLimiter`**:
  - `new(max_requests, window_secs)`: создание нового лимитера
  - `check(key)`: проверка и обновление счетчика для ключа
    - Автоочистка старых timestamp'ов
    - Добавление нового при успешной проверке
    - Возврат `true` если лимит не превышен
- **Middleware функция `rate_limit_middleware`**:
  - Использует глобальный статический `RateLimiter` через `OnceLock`
  - Лимит: 100 запросов в минуту на IP
  - Определение IP клиента: приоритет `X-Forwarded-For` заголовка, иначе "unknown"
  - Возвращает `429 TOO_MANY_REQUESTS` при превышении лимита
  - Пропускает запрос дальше при успешной проверке

### 3. `src/routes/mod.rs`
- **Обновлены импорты**: добавлен `use crate::middleware::rate_limit_middleware`
- **Удалён импорт**: `middleware::{self, Next}` (неиспользуемый)
- **Добавлен middleware слой**: `.layer(axum::middleware::from_fn(rate_limit_middleware))`
- **Позиция в цепочке**: после объединения всех маршрутов, перед `SetRequestIdLayer`
- **Сохранение существующих слоёв**: `PropagateRequestIdLayer` остаётся последним

**Технические детали**
- **Потокобезопасность**: использование `Arc<Mutex<>>` для конкурентного доступа
- **In-memory хранение**: простой HashMap для хранения счетчиков
- **Определение IP**: поддержка прокси через `X-Forwarded-For`
- **Очистка устаревших данных**: автоматическое удаление timestamp'ов старше окна
- **Статический лимитер**: глобальный экземпляр через `OnceLock` для всего приложения

**Преимущества изменений**
- **Защита от DDoS**: предотвращение чрезмерной нагрузки на API эндпоинты
- **Справедливое распределение**: ограничение по IP-адресам
- **Производительность**: минимальные накладные расходы на проверку
- **Гибкость**: легко изменить лимиты (100/60) в конфигурации
- **Интеграция**: seamless встраивание в существующую цепочку middleware
- **Совместимость**: сохранение всех существующих заголовков request ID

# Added input validation and sanitization added to various controllers and services !! | 7cbde21b6bc7a1ea34b439cffe62ab371ab490e7

## Добавление валидации и санитизации входных данных в различные контроллеры и сервисы

**Описание изменений**
Добавлена комплексная валидация входных параметров во все контроллеры и санитизация HTML контента в CMS сервисе для предотвращения уязвимостей безопасности.

**Изменённые файлы**

### 1. `app/Http/Controllers/AstroController.php`
- **Валидация параметров `events()`**:
  - `date`: опциональный, формат даты
  - `limit`: опциональный, целое число 1-100
  - `type`: опциональный, строка до 50 символов
- **Использование**: передача валидированных данных в сервис вместо сырых query параметров

### 2. `app/Http/Controllers/DashboardController.php`
- **Валидация `downloadTelemetryCsv()`**:
  - `source_file`: обязательный, строка до 255 символов
- **Санитизация имени файла**: удаление символов `/`, `\`, `..` для предотвращения path traversal атак
- **Упрощение**: замена ручной проверки на валидацию Laravel

### 3. `app/Http/Controllers/IssController.php`
- **Валидация параметра `trend()`**:
  - `limit`: опциональный, целое число 1-1000
- **Значение по умолчанию**: 240 при отсутствии параметра
- **Типизация**: гарантированное целое число в безопасном диапазоне

### 4. `app/Http/Controllers/JwstController.php`
- **Валидация `selectObservation()`**:
  - `obs_id`: обязательный, строка до 255 символов
  - `program`, `suffix`, `inst`: опциональные строки до 255 символов
  - `url`, `link`: опциональные, валидация как URL
  - `caption`: опциональный, строка до 1000 символов
- **Валидация `feed()`**:
  - `source`: опциональный, только значения `jpg`, `suffix`, `program`
  - `suffix`: опциональный, строка до 50 символов
  - `program`: опциональный, целое число ≥1
  - `instrument`: опциональный, только допустимые инструменты JWST
  - `page`: опциональный, целое число ≥1
  - `perPage`: опциональный, целое число 1-100

### 5. `app/Services/CmsService.php`
- **Добавлена санитизация HTML** в методе `getPageContent()`:
  - Вызов приватного метода `sanitizeHtml()` для очистки контента
  - Очистка выполняется только если страница существует
- **Метод `sanitizeHtml(string $html): string`**:
  - Разрешает только безопасные HTML теги: `<p><br><strong><em><u><h1>-<h6><ul><ol><li><a><img>`
  - Использует `strip_tags()` для удаления потенциально опасных тегов
  - Предотвращает XSS (Cross-Site Scripting) атаки через контент CMS

**Технические детали**
- **Валидация Laravel**: использование встроенного метода `validate()` Request объекта
- **Защита от инъекций**: санитизация перед использованием в SQL запросах (через Eloquent)
- **Path traversal protection**: удаление опасных символов из имён файлов
- **XSS protection**: очистка HTML контента перед отображением
- **Консистентность**: все валидационные ошибки обрабатываются через базовый контроллер

**Преимущества изменений**
- **Безопасность**: защита от SQL-инъекций, XSS, path traversal атак
- **Надёжность**: гарантия корректных типов и диапазонов входных данных
- **Пользовательский опыт**: понятные сообщения об ошибках валидации
- **Поддерживаемость**: централизованные правила валидации в контроллерах
- **Производительность**: раннее отсечение некорректных запросов
- **Соответствие стандартам**: использование best practices безопасности веб-приложений

# Added CSRF protection to all routes and removed exception for /upload | cf88153a6d9fd700c76453ccd7b6fd97e07269e4

## Добавление CSRF защиты ко всем маршрутам и удаление исключения для /upload

**Описание изменений**
Включена полная CSRF защита для всего приложения путём добавления middleware `VerifyCsrfToken` в группу маршрутов и удаления исключения для эндпоинта `/upload`.

**Изменённые файлы**

### 1. `app/Http/Middleware/VerifyCsrfToken.php`
- **Очищен список исключений**: удалена строка `'/upload', // disabled CSRF on purpose for training`
- **Теперь список пуст**: CSRF защита применяется ко всем маршрутам без исключений
- **Комментарий добавлен**: `// CSRF protection enabled for all routes`
- **Безопасность восстановлена**: убрано преднамеренное отключение защиты для обучения

### 2. `routes/web.php`
- **Добавлен CSRF middleware**: `\App\Http\Middleware\VerifyCsrfToken::class` добавлен в массив middleware
- **Порядок middleware**: `LoggingMiddleware` → `RateLimitingMiddleware` → `VerifyCsrfToken`
- **Область действия**: CSRF защита применяется ко всем маршрутам внутри группы
- **Маршруты под защитой**: все панели (dashboard, iss, jwst, osdr, astro) и API эндпоинты

**Технические детали**
- **CSRF токены**: Laravel автоматически проверяет наличие токена для всех не-GET запросов
- **Сессионные токены**: токены генерируются для каждой пользовательской сессии
- **Исключения HTTP методы**: GET, HEAD, OPTIONS обычно не требуют CSRF защиты (но middleware всё равно применяется)
- **Интеграция с Blade**: автоматическая генерация скрытых полей `@csrf` в формах
- **AJAX запросы**: необходимо передавать токен в заголовке `X-CSRF-TOKEN`

**Преимущества изменений**
- **Повышенная безопасность**: защита от Cross-Site Request Forgery атак
- **Единая политика**: отсутствие "дыр" в безопасности из-за исключений
- **Соответствие best practices**: включение CSRF защиты по умолчанию
- **Защита данных**: предотвращение несанкционированных операций от имени пользователя
- **Устранение уязвимости**: удаление потенциально опасного исключения `/upload`
- **Простота конфигурации**: все маршруты используют одинаковый уровень защиты

# add cmspage.php | 54b8dd2b3ad53974cb326aa0f7d0b28976151187

## Добавление модели CmsPage для работы со страницами CMS

**Описание изменений**
Создана новая Eloquent модель `CmsPage` для взаимодействия с таблицей `cms_pages` в базе данных, обеспечивающая типизированный доступ к данным страниц CMS.

**Изменённые файлы**

### 1. `app/Models/CmsPage.php` — **новый файл**
- **Eloquent модель**: наследуется от базового класса `Model`
- **Использует трейт**: `HasFactory` для создания фабрик и сидов
- **Указание таблицы**: `protected $table = 'cms_pages'`
- **Заполняемые поля** (`$fillable`):
  - `slug` — текстовый идентификатор страницы
  - `title` — заголовок страницы
  - `body` — содержимое страницы (HTML/текст)
- **Автоматические поля**: `id`, `created_at`, `updated_at` не указаны в `$fillable` (управляются Laravel)
- **Отсутствие кастомной логики**: базовая модель без дополнительных методов

**Технические детали**
- **Связь с БД**: соответствует структуре таблицы `cms_pages` из `db/init.sql`
- **Mass assignment protection**: только указанные поля могут быть заполнены массово
- **Автоматические timestamp'ы**: Eloquent автоматически управляет `created_at` и `updated_at`
- **Готовность к использованию**: модель может сразу использоваться в репозиториях и сервисах

**Преимущества изменений**
- **Типобезопасность**: строгая типизация данных через Eloquent
- **Упрощение кода**: замена сырых SQL запросов на методы модели
- **Интеграция с Laravel**: полная совместимость с фасадами, отношениями, скоупами
- **Поддерживаемость**: централизованное управление структурой данных страниц
- **Тестируемость**: возможность создания фабрик для тестирования CMS функционала
- **Масштабируемость**: готовность к добавлению отношений с другими моделями

# Added pagination to OSDR and telemetry lists | 273c6a759e536c673608ec6403840e02efc21c54

## Добавление пагинации к спискам OSDR и телеметрии

**Описание изменений**
Реализована полноценная пагинация для списков OSDR элементов и телеметрии на дашборде. Добавлены пагинированные методы в репозитории и сервисы, обновлены контроллеры и представления.

**Изменённые файлы**

### 1. `app/Http/Controllers/DashboardController.php`
- **Добавлен параметр `Request $request`** в метод `index()`
- **Замена данных телеметрии**: использование `getLatestTelemetryPaginated(10)` вместо статичного массива из DTO
- **Передача в представление**: пагинированная коллекция `$telemetry`

### 2. `app/Http/Controllers/OsdrController.php`
- **Убрана ручная пагинация**: удалён параметр `limit` из запроса
- **Использование пагинированного сервиса**: вызов `getOsdrListPaginated(20)`
- **Структура ответа**: передача `'osdr_items' => $osdrItems` в представление

### 3. `app/Repositories/TelemetryRepository.php`
- **Новый метод `getLatestTelemetryPaginated()`**: возвращает `paginate($perPage)` с сортировкой по времени
- **Новый метод `getTelemetryBySourceFilePaginated()`**: пагинированная версия для фильтрации по файлу
- **Сохранение существующих методов**: непоганированные версии остались для обратной совместимости

### 4. `app/Services/OsdrService.php`
- **Новый метод `getOsdrListPaginated()`**:
  - Получает все данные OSDR с лимитом 1000 для точного подсчёта
  - Преобразует в плоскую структуру через `flattenOsdr()`
  - Вычисляет общее количество элементов (`$total`)
  - Определяет текущую страницу через `request('page', 1)`
  - Создаёт ручной пагинатор `LengthAwarePaginator` с правильными offset/limit
  - Поддерживает URL и параметры пагинации

### 5. `app/Services/TelemetryService.php`
- **Добавлены пагинированные методы**:
  - `getLatestTelemetryPaginated()`: прокси к репозиторию
  - `getTelemetryBySourceFilePaginated()`: пагинированная версия для конкретного файла

### 6. `resources/views/dashboard.blade.php`
- **Добавлена пагинация телеметрии**: блок после таблицы с условием `@if ($telemetry->hasPages())`
- **Информация о странице**: "Showing X to Y of Z results"
- **Навигация**: кнопки "Previous" и "Next" с обработкой активных/неактивных состояний
- **Ссылки**: `$telemetry->previousPageUrl()` и `$telemetry->nextPageUrl()`
- **Адаптивный дизайн**: Bootstrap классы для выравнивания

### 7. `resources/views/osdr.blade.php`
- **Обновлён цикл данных**: `@forelse($osdr_items as $row)` вместо `array_slice($items, 0, 50)`
- **Добавлена пагинация OSDR**: аналогичная структура как для телеметрии
- **Отображение информации**: количество элементов, навигация вперед/назад
- **Удалено ограничение**: больше нет жёсткого ограничения в 50 элементов

### 8. `services/rust-iss/src/handlers/osdr.rs`
- **Добавлена поддержка параметров запроса**: извлечение `page` из query string
- **Расширенная логика пагинации**:
  - Фиксированный `limit = 20`
  - Вычисление `offset = (page - 1) * limit`
  - Получение общего количества записей через `SELECT COUNT(*)`
  - Добавление `OFFSET $2` в SQL запрос
  - Логирование параметров пагинации
- **Структура ответа**: сохранение формата JSON для совместимости

**Технические детали**
- **LengthAwarePaginator**: ручное создание в OSDR сервисе для нестандартных данных
- **OFFSET/LIMIT**: классический подход к пагинации в PostgreSQL
- **Bootstrap пагинация**: стандартные классы для стилизации
- **Совместимость API**: Rust сервис возвращает те же данные, но с пагинацией
- **Производительность**: подсчёт общего количества записей для точной пагинации

**Преимущества изменений**
- **Улучшение UX**: навигация по большим наборам данных без перегрузки страницы
- **Производительность**: ограничение количества элементов на странице
- **Масштабируемость**: готовность к росту количества записей телеметрии и OSDR
- **Консистентность**: единый подход к пагинации во всём приложении
- **Гибкость**: возможность настройки количества элементов на странице

# Added trend analysis feature to ISS service | dbd36a5da2f8cddb258ddc6aec89c7f2e9802140

## Добавление функции анализа тренда в сервис МКС и обновление интерфейса

**Описание изменений**
Добавлена новая функциональность для расширенного анализа тренда движения МКС с разделением эндпоинтов, обновлён пользовательский интерфейс страницы ISS и улучшена архитектура сервисов.

**Изменённые файлы**

### 1. `app/Http/Controllers/IssController.php` (Laravel)
- **Добавлен новый метод `trendAnalysis()`**:
  - Обработчик API эндпоинта `/api/iss/trend/analysis`
  - Использует сервис `IssService::getTrendAnalysis()` для получения данных
  - Стандартная обработка ошибок через `errorResponse()`

### 2. `app/Services/IssService.php` (Laravel)
- **Добавлен новый метод `getTrendAnalysis()`**:
  - Выполняет запрос к Rust-сервису по эндпоинту `iss/trend/analysis`
  - Возвращает массив с аналитическими данными о тренде движения МКС

### 3. `resources/views/iss.blade.php`
- **Обновление отображения данных**:
  - Обёртка блоков данных в элементы с ID для динамического обновления
  - Добавлены `span` с уникальными ID для каждого поля данных
- **Добавление JavaScript функций**:
  - `loadLatestData()`: асинхронная загрузка последних данных и анализа тренда
  - Обновление элементов DOM через `textContent` без перезагрузки страницы
  - Периодическое обновление данных каждые 15 секунд
- **Улучшение UX**: разделение загрузки тренда и последних данных

### 4. `routes/web.php`
- **Добавлен новый маршрут API**:
  - `GET /api/iss/trend/analysis` → `IssController::trendAnalysis`
  - Расположен в группе middleware (логирование, rate limiting, CSRF защита)

### 5. `src/handlers/iss.rs` (Rust)
- **Создана новая структура `IssTrendResponse`**:
  - Поле `points: Vec<IssPoint>` для передачи точек тренда
- **Разделение эндпоинтов**:
  - `iss_trend()`: возвращает массив точек для визуализации (`IssTrendResponse`)
  - `iss_trend_analysis()`: возвращает аналитические данные (`Trend`)
- **Обновлённая логика**: извлечение данных через сервисный метод `get_iss_trend_points()`

### 6. `src/routes/mod.rs` (Rust)
- **Добавлен новый маршрут**:
  - `.route("/iss/trend/analysis", get(handlers::iss_trend_analysis))`
  - Включён в группу маршрутов ISS наряду с существующими

### 7. `src/services/iss.rs` (Rust)
- **Добавлен новый метод `get_iss_trend_points()`**:
  - Получает исторические данные МКС через репозиторий
  - Преобразует в вектор структур `IssPoint`
  - Извлекает числовые поля: широта, долгота, скорость, высота
  - Обратный порядок для хронологической последовательности
- **Интеграция с репозиторием**: использование `get_iss_data_range()`

### 8. `src/services/mod.rs` (Rust)
- **Добавлена новая структура `IssPoint`**:
  - Поля: `lat`, `lon`, `at`, `velocity`, `altitude`
  - Реализация `Serialize` для JSON-сериализации
  - Используется для передачи точек тренда клиенту
- **Расширен трейт `IssService`**:
  - Добавлен метод `get_iss_trend_points(&self, limit: usize)`

**Технические детали**
- **Разделение ответственности**: отдельные эндпоинты для сырых данных и аналитики
- **Динамическое обновление**: JavaScript обновляет только изменяемые части интерфейса
- **Совместимость API**: сохранение форматов ответов для существующих клиентов
- **Архитектурная чистота**: сервисный слой инкапсулирует логику получения данных
- **Типизация**: строгие типы в Rust для предотвращения ошибок времени выполнения

**Преимущества изменений**
- **Улучшенная аналитика**: разделение данных тренда и их визуализации
- **Интерактивность**: автоматическое обновление данных на странице без перезагрузки
- **Производительность**: уменьшение размера передаваемых данных за счёт разделения эндпоинтов
- **Гибкость**: возможность независимой настройки обновления разных блоков данных
- **Масштабируемость**: готовность к добавлению новых метрик анализа тренда
- **Пользовательский опыт**: актуальные данные в реальном времени с минимальной задержкой

# Update AstroController and astro.blade.php to reflect changes in API request parameters | c483b9fa87ecac448ad2867c20dcd7055457830e

## Обновление AstroController и astro.blade.php для отражения изменений параметров API запросов

**Описание изменений**
Адаптация параметров запросов к Astronomy API в контроллере и обновление пользовательского интерфейса формы фильтрации для соответствия новому формату данных.

**Изменённые файлы**

### 1. `app/Http/Controllers/AstroController.php`
- **Обновление правил валидации** в методе `events()`:
  - Удалены старые параметры: `date`, `limit`, `type`
  - Добавлены новые параметры для Astronomy API v2:
    - `lat` и `lon`: координаты (опциональные числовые значения)
    - `elevation`: высота наблюдателя (опциональное числовое значение)
    - `from_date` и `to_date`: диапазон дат (опциональные, формат даты)
    - `time`: время суток для расчётов (опциональная строка)
- **Передача параметров**: валидированные данные передаются в сервис без изменений

### 2. `resources/views/astro.blade.php`
- **Полная переработка формы фильтрации**:
  - Изменён HTML-шаблон: `.row g-2` → `.d-flex gap-2 flex-nowrap`
  - **Новые поля формы**:
    - `from_date`: дата начала периода (тип date, значение "2025-11-29")
    - `to_date`: дата окончания периода (тип date, значение "2026-11-29")
    - `time`: время расчёта (тип time, значение "00:00:00")
  - **Изменённые значения по умолчанию**:
    - Координаты: `lat=65.9558`, `lon=37.6171` (вместо 55.7558/37.6176)
    - Высота: `elevation=7` (без изменений)
  - **Удалённое поле**: `days` (больше не поддерживается API)
  - **Добавлены всплывающие подсказки** (title) для всех полей на русском языке
- **Обновление JavaScript функции автозагрузки**:
  - Вызов `load()` с полным набором новых параметров
  - Передача: `lat`, `lon`, `elevation`, `from_date`, `to_date`, `time`
  - Удалён параметр `days` из вызова функции

**Технические детали**
- **Формат дат**: использование HTML5 input type="date" и "time" для удобства выбора
- **Гибкая компоновка**: flex-контейнер с отступами для адаптивного отображения
- **Обработка параметров**: форма автоматически собирает все поля при отправке
- **Обратная совместимость**: сохранение обработки событий и сортировки таблицы
- **Семантика HTML**: правильные типы полей для лучшей доступности

**Преимущества изменений**
- **Совместимость с API**: полная поддержка нового формата Astronomy API v2
- **Улучшенный UX**: интуитивно понятные поля выбора даты и времени
- **Точность настройки**: возможность указания точного временного диапазона
- **Производительность**: фильтрация данных на стороне сервера через параметры
- **Локализация**: русские подсказки для всех элементов управления
- **Адаптивность**: компактное расположение полей на разных размерах экрана

# Added logging directory and file creation, and sanitization of CMS block content | 17d9f1f11808514bef5ffff97080fe4318afe67d

## Добавление каталога логирования, создание файлов и санитизация контента CMS блоков

**Описание изменений**
Улучшение безопасности и системного администрирования: добавление автоматического создания директории и файлов для логов Laravel, а также санитизация HTML контента в CMS блоках для предотвращения XSS-уязвимостей.

**Изменённые файлы**

### 1. `services/php-web/entrypoint.sh`
- **Добавлено создание директории для логов**:
  - Команда `mkdir -p "$APP_DIR/storage/logs"`
  - Рекурсивное создание каталога если он не существует
  - Настройка прав доступа: `chown -R www-data:www-data` и `chmod -R 775`
- **Добавлено создание файла логов**:
  - Команда `touch "$APP_DIR/storage/logs/laravel.log"`
  - Создание стандартного файла логов Laravel
  - Настройка прав: `chown www-data:www-data` и `chmod 664`
- **Местоположение**: после настройки прав доступа к storage, перед выполнением миграций

### 2. `app/Services/DashboardService.php`
- **Добавлена санитизация контента CMS блоков**:
  - Проверка существования блока: `if ($cmsBlock)`
  - Вызов приватного метода `sanitizeHtml()` для очистки контента
  - Применяется к полю `$cmsBlock->content`
- **Создан приватный метод `sanitizeHtml()`**:
  - Параметр: `string $html` (входной HTML)
  - Возвращает: `string` (очищенный HTML)
  - Использует `strip_tags()` с белым списком разрешённых тегов
  - Разрешённые HTML теги: `<p><br><strong><em><u><h1><h2><h3><h4><h5><h6><ul><ol><li><a><img>`
  - Удаляет все потенциально опасные теги (script, style, iframe и др.)

**Технические детали**
- **Права доступа к логам**: 775 для директории, 664 для файла (чтение/запись для www-data, чтение для группы)
- **Иерархия логов**: стандартная структура Laravel (`storage/logs/laravel.log`)
- **Безопасность санитизации**: только базовые HTML теги без атрибутов стилей и событий
- **Место применения**: санитизация выполняется при получении данных, перед передачей в DTO
- **Неизменность данных**: оригинальный контент в БД остаётся без изменений

**Преимущества изменений**
- **Автоматизация развёртывания**: гарантия наличия лог-файлов при запуске контейнера
- **Безопасность**: защита от XSS-атак через пользовательский контент CMS
- **Надёжность логирования**: предотвращение ошибок из-за отсутствия директории/файла
- **Соответствие best practices**: правильные права доступа для веб-сервера
- **Консистентность**: единый подход к санитизации контента во всём приложении
- **Производительность**: минимальные накладные расходы на очистку HTML

# Removed unused code and database migrations | 25a817fc1db0b59e5ac8e88031e37a3846e4eb9e

## Удаление неиспользуемого кода и миграций базы данных

**Описание изменений**
Очистка кодовой базы Laravel-приложения от устаревших и неиспользуемых компонентов: удалены модель, репозиторий, вспомогательный класс и миграции, которые не используются в текущей реализации проекта.

**Изменённые файлы**

### 1. `app/Models/DummyTrainingMarker.php` — **полностью удалён**
- **Eloquent модель** для таблицы `dummy_training_marker`
- **Поля**: `id`, `note` (nullable), `created_at`, `updated_at`
- **Функциональность**: трейт `HasFactory`, кастинг полей дат
- **Причина удаления**: не используется в приложении, таблица создана для тренировочных целей

### 2. `app/Repositories/DummyTrainingMarkerRepository.php` — **полностью удалён**
- **Репозиторий** для работы с моделью `DummyTrainingMarker`
- **Методы**:
  - `getMarkersWithNotes()`: получение маркеров с заполненными заметками
  - `getRecentMarkers()`: получение последних маркеров с лимитом
- **Наследование**: от абстрактного `BaseRepository`
- **Причина удаления**: не используется, так как модель удалена

### 3. `app/Support/JwstHelper.php` — **полностью удалён**
- **Вспомогательный класс** для работы с JWST API
- **Конфигурация**: получение `JWST_HOST`, `JWST_API_KEY`, `JWST_EMAIL` из env
- **Методы**:
  - `get()`: выполнение HTTP-запросов с заголовками x-api-key и email
  - `pickImageUrl()`: рекурсивный поиск URL изображений в массивах
- **Особенности**: использование cURL, таймаут 30 секунд, обработка JSON
- **Причина удаления**: функционал полностью перенесён в `JwstClient`

### 4. `database/migrations/2025_11_03_193635_dummy_training_marker.php` — **полностью удалён**
- **Миграция для создания таблицы** `dummy_training_marker`
- **Структура**: `id`, `note` (string nullable), `timestamps`
- **Операции**: `up()` — создание, `down()` — удаление таблицы
- **Причина удаления**: таблица больше не нужна, модель и репозиторий удалены

### 5. `database/migrations/2025_11_20_120000_create_cms_blocks_table.php` — **полностью удалён**
- **Миграция для создания таблицы** `cms_blocks`
- **Структура**: 
  - `id` (bigIncrements), `slug` (unique string)
  - `title` (string), `content` (text)
  - `is_active` (boolean default true), `timestamps`
- **Операции**: `up()` — создание, `down()` — удаление таблицы
- **Причина удаления**: миграция дублирует структуру из `db/init.sql`, не требуется в Laravel-части

**Технические детали**
- **Безопасное удаление**: отсутствие каскадных зависимостей от удаляемых компонентов
- **Согласованность архитектуры**: все зависимости JWST теперь используют клиентский слой
- **Чистота БД**: таблица `dummy_training_marker` может быть удалена вручную через отдельную миграцию
- **Соответствие контейнерам**: структура `cms_blocks` управляется через SQL-скрипты в Docker
- **Миграционный порядок**: удаление не нарушает порядок применения оставшихся миграций

**Преимущества изменений**
- **Уменьшение сложности**: упрощение кодовой базы и архитектуры проекта
- **Улучшение поддерживаемости**: удаление неиспользуемого "мёртвого" кода
- **Устранение дублирования**: единый источник истины для структуры таблиц
- **Увеличение производительности**: уменьшение времени загрузки и анализа кода
- **Безопасность**: исключение потенциально уязвимого устаревшего кода
- **Ясность архитектуры**: чёткое разделение ответственности между слоями приложения

# Update .env and docker-compose.yml files with new environment variables and configurations | ef83d97753778d120fe801a0f54aff0030e6facb

## Обновление .env и docker-compose.yml файлов с новыми переменными окружения и конфигурациями

**Описание изменений**
Централизация конфигурации приложения: полная реструктуризация файла .env и переход на использование переменных окружения в docker-compose.yml для всех сервисов.

**Изменённые файлы**

### 1. `.env`
- **Полная реорганизация структуры**:
  - Разделение на логические секции с комментариями
  - Удаление дублирующихся строк (NASA_API_KEY, FETCH_EVERY_SECONDS)
- **Добавлены новые переменные**:
  - **Конфигурация БД**: `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`
  - **Rust ISS сервис**:
    - `DATABASE_URL`, `REDIS_URL` (для подключения к Redis)
    - `WHERE_ISS_URL` (API ISS)
    - Интервалы запросов: `ISS_EVERY_SECONDS=120`, `APOD_EVERY_SECONDS=43200`, `NEO_EVERY_SECONDS=7200`, `DONKI_EVERY_SECONDS=3600`, `SPACEX_EVERY_SECONDS=3600`
  - **PHP/Laravel конфигурация**:
    - `JWST_HOST`, `JWST_API_KEY`, `JWST_EMAIL`, `JWST_PROGRAM_ID`
    - `ASTRO_APP_ID`, `ASTRO_APP_SECRET`
    - `APP_ENV`, `APP_DEBUG`, `APP_URL`
    - Параметры подключения к БД: `DB_CONNECTION`, `DB_HOST`, `DB_PORT`, `DB_DATABASE`, `DB_USERNAME`, `DB_PASSWORD`
  - **Legacy сервис**: `PAS_LEGACY_PERIOD=300`
- **Оптимизированные значения**:
  - `FETCH_EVERY_SECONDS=600` (вместо 120/300)
  - Исправленный `NASA_API_URL`

### 2. `docker-compose.yml`
- **Внедрение env_file для всех сервисов**:
  - Каждый сервис теперь использует `env_file: - .env`
  - Удаление хардкодных значений из блоков `environment`
- **Обновление переменных окружения**:
  - **db**: использование `${POSTGRES_DB}`, `${POSTGRES_USER}`, `${POSTGRES_PASSWORD}`
  - **rust-iss**: добавление всех интервальных переменных, использование `${VARIABLE}` синтаксиса
  - **php-web**: полная замена хардкодных значений на переменные окружения
  - **pascal-legacy**: переход на переменные БД из .env
- **Унификация подключения к БД**:
  - Все сервисы используют одинаковые параметры подключения
  - Прямое использование `DB_HOST`, `DB_PORT`, `DB_USERNAME`, `DB_PASSWORD`, `DB_DATABASE`

**Технические детали**
- **Синтаксис переменных**: использование `${VARIABLE_NAME}` для подстановки значений
- **Секции конфигурации**: чёткое разделение по функциональным областям
- **Совместимость**: сохранение имён переменных для обратной совместимости
- **Безопасность**: конфиденциальные данные (ключи API, пароли) хранятся в одном файле
- **Оркестрация**: docker-compose автоматически подставляет значения из .env

**Преимущества изменений**
- **Единый источник истины**: все настройки хранятся в одном файле .env
- **Упрощение развёртывания**: изменение конфигурации без редактирования docker-compose.yml
- **Гибкость**: лёгкая настройка интервалов запросов для разных сервисов
- **Безопасность**: отсутствие хардкодных секретов в docker-compose.yml
- **Поддерживаемость**: понятная структура с комментариями
- **Масштабируемость**: лёгкое добавление новых сервисов с аналогичным подходом
- **Совместимость с CI/CD**: возможность подстановки переменных в пайплайнах

# Deleted legacy Pascal code file services/pascal-legacy/legacy.pas | 5c7ae5c0397517461c7eb3ac685f533f02731757

## Удаление legacy Pascal кода из сервиса pascal-legacy

**Описание изменений**
Удаление устаревшего кода на языке Pascal, который был заменён на современную реализацию на Python. Файл `legacy.pas` больше не используется после миграции сервиса на Python-стек.

**Изменённые файлы**

### 1. `services/pascal-legacy/legacy.pas` — **полностью удалён**
- **Исходный код на Free Pascal**: программа `LegacyCSV`
- **Функциональность**:
  - Генерация CSV файлов с телеметрическими данными
  - Импорт данных в PostgreSQL через `psql \copy`
  - Циклическое выполнение с настраиваемым интервалом
- **Структура программы**:
  - **Вспомогательная функция `Env()`**: получение переменных окружения с значениями по умолчанию
  - **Процедура `GenerateAndCopy()`**: 
    - Создание CSV файла с именем по шаблону `telemetry_YYYYMMDD_HHMMSS.csv`
    - Запись заголовка и строки данных с полями: `recorded_at`, `voltage`, `temp`, `source_file`
    - Генерация случайных значений для напряжения (3.2-12.6V) и температуры (-50..+80°C)
    - Подключение к PostgreSQL и импорт через `psql` с передачей пароля через окружение
  - **Основной цикл**:
    - Получение интервала генерации из переменной `GEN_PERIOD_SEC` (по умолчанию 300 секунд)
    - Бесконечный цикл с паузой между итерациями
    - Логирование времени выполнения в формате `hh:nn:ss`
- **Технические особенности**:
  - Использование модулей: `Classes`, `SysUtils`, `DateUtils`, `Process`
  - Режим компиляции: `{$mode objfpc}{$H+}`
  - Обработка ошибок: try-finally для файловых операций
  - Безопасность: передача пароля БД через переменную окружения `PGPASSWORD`

**Технические детали**
- **Причина удаления**: код был заменён на Python-версию (`legacy.py`) в предыдущих коммитах
- **Миграция функционала**: вся логика генерации CSV/XLSX и импорта в БД перенесена в Python
- **Устаревшая зависимость**: удаление необходимости в компиляторе Free Pascal (`fp-compiler`)
- **Совместимость Docker**: образ теперь использует `python:3.9-slim` вместо Pascal окружения
- **Очистка проекта**: удаление неиспользуемого бинарного кода и исходных файлов

**Преимущества изменений**
- **Современный стек**: использование поддерживаемого Python вместо устаревшего Pascal
- **Упрощение поддержки**: стандартные инструменты и библиотеки Python
- **Улучшение функциональности**: новая версия поддерживает генерацию XLSX с формулами Excel
- **Снижение сложности**: удаление зависимости от компилятора и специфичных Pascal-модулей
- **Увеличение безопасности**: Python версия использует параметризованные запросы к БД
- **Консистентность кодовой базы**: единый язык программирования для всех сервисов
- **Уменьшение размера образа**: удаление Pascal runtime и компилятора